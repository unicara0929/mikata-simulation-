<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MIKATA - å®¶è¨ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼ãƒ»ä½å®…è³¼å…¥ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.08);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 40px rgba(0,0,0,0.15);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 15px;
            --radius-xl: 20px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans JP', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a3a5c 0%, #2c5f8a 100%);
            min-height: 100vh;
            padding: 20px;
            padding-bottom: 80px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: var(--shadow-lg);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1a3a5c 0%, #2c5f8a 100%);
            color: white;
            padding: 40px 30px;
            text-align: center;
            position: relative;
        }

        .share-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            background: rgba(255,255,255,0.2);
            border: 2px solid white;
            color: white;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .share-btn:hover {
            background: #ff5757;
            border-color: #ff5757;
            color: white;
            transform: translateY(-2px);
        }

        .logo {
            font-size: 36px;
            font-weight: 900;
            letter-spacing: 3px;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header h1 {
            font-size: 22px;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .header p {
            opacity: 0.9;
            font-size: 15px;
        }

        .content {
            padding: 40px;
        }

        /* ãƒ—ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ */
        .preset-section {
            margin-bottom: 30px;
            text-align: center;
        }

        .preset-title {
            font-size: 16px;
            color: #666;
            margin-bottom: 15px;
        }

        .preset-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .preset-btn {
            padding: 12px 24px;
            background: white;
            border: 2px solid #1a3a5c;
            color: #1a3a5c;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .preset-btn:hover {
            background: #ff5757;
            color: white;
            border-color: #ff5757;
            transform: translateY(-2px);
        }

        /* ç°¡æ˜“å…¥åŠ›ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .simple-input {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 20px;
            font-weight: 700;
            color: #333;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 25px;
        }

        .input-group {
            position: relative;
        }

        .input-label {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            color: #333;
            font-weight: 600;
            font-size: 15px;
        }

        .help-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            background: #1a3a5c;
            color: white;
            border-radius: 50%;
            font-size: 12px;
            cursor: help;
            position: relative;
        }

        .help-icon:hover::after {
            content: attr(data-tip);
            position: absolute;
            bottom: 25px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1000;
            font-weight: normal;
        }

        .input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        input[type="number"],
        input[type="range"],
        select {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
            background: white;
        }

        input[type="number"]:focus,
        select:focus {
            outline: none;
            border-color: #1a3a5c;
            box-shadow: 0 0 0 3px rgba(26, 58, 92, 0.1);
        }

        input[type="range"] {
            padding: 0;
            height: 8px;
            background: linear-gradient(to right, #1a3a5c, #2c5f8a);
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        input[type="range"]::-webkit-slider-thumb {
            width: 20px;
            height: 20px;
            background: white;
            border: 3px solid #1a3a5c;
            border-radius: 50%;
            cursor: pointer;
        }

        .unit-label {
            color: #666;
            font-size: 14px;
            font-weight: 600;
            min-width: 40px;
        }

        .slider-value {
            min-width: 60px;
            text-align: right;
            font-weight: 600;
            color: #ff5757;
        }

        /* è¨ˆç®—ãƒœã‚¿ãƒ³ï¼ˆç”»é¢ä¸‹éƒ¨ã«å›ºå®šï¼‰ */
        .calculate-btn-fixed {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }

        .calculate-btn-fixed .calculate-btn {
            max-width: 800px;
            margin: 0 auto;
            display: block;
        }

        .calculate-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #ff5757 0%, #ff8a80 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(255, 87, 87, 0.3);
        }

        .calculate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 87, 87, 0.4);
        }

        .calculate-btn:active {
            transform: translateY(0);
        }

        /* è©³ç´°è¨­å®šãƒˆã‚°ãƒ« */
        /* è©³ç´°è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .advanced-settings-container {
            /* å¸¸ã«è¡¨ç¤º */
        }

        .advanced-section {
            background: #f8f9fa;
            border-radius: var(--radius-lg);
            margin-bottom: 8px;
            overflow: hidden;
        }

        .advanced-section-title {
            font-size: 18px;
            font-weight: 700;
            color: #333;
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        /* ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ */
        .accordion-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
            padding: 20px 25px;
            transition: background 0.2s;
            border-left: 4px solid #ff5757;
        }

        .accordion-header:hover {
            background: #f0f1f2;
        }

        .accordion-chevron {
            font-size: 18px;
            color: #999;
            transition: transform 0.3s ease;
            flex-shrink: 0;
            margin-left: 12px;
        }

        .accordion-header.open .accordion-chevron {
            transform: rotate(180deg);
        }

        .accordion-body {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease;
        }

        .accordion-body.open {
            max-height: 8000px;
        }

        .accordion-body-inner {
            padding: 0 25px 25px;
        }

        /* ã‚»ãƒ‘ãƒ¬ãƒ¼ã‚¿ãƒ¼ */
        .advanced-divider {
            display: flex;
            align-items: center;
            gap: 16px;
            margin: 40px 0 30px;
        }

        .advanced-divider-line {
            flex: 1;
            height: 1px;
            background: #e0e0e0;
        }

        .advanced-divider-label {
            font-size: 15px;
            font-weight: 600;
            color: #999;
            text-align: center;
            white-space: nowrap;
        }

        .advanced-divider-sublabel {
            display: block;
            font-size: 12px;
            font-weight: 400;
            color: #bbb;
            margin-top: 2px;
        }

        /* çµ±ä¸€æƒ…å ±ãƒœãƒƒã‚¯ã‚¹ */
        .info-box {
            padding: 12px 15px;
            border-radius: var(--radius-sm);
            margin-bottom: 15px;
            background: #f0f1f2;
            border-left: 3px solid #ddd;
        }

        .info-box p {
            font-size: 13px;
            color: #555;
            margin: 0;
            line-height: 1.6;
        }

        .info-box ul {
            font-size: 13px;
            color: #555;
            margin: 0;
            padding-left: 20px;
            line-height: 1.8;
        }

        .info-box-title {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        /* çµ±ä¸€å­ã©ã‚‚ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .child-section {
            background: white;
            padding: 15px;
            border-radius: var(--radius-sm);
            margin-bottom: 15px;
            border: 1px solid #e0e0e0;
        }

        .child-section-label {
            font-size: 14px;
            font-weight: 700;
            color: #333;
            margin: 0 0 12px 0;
        }

        /* çµ±ä¸€è‡¨æ™‚æ”¯å‡ºã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .temp-expense-section {
            background: white;
            padding: 12px;
            border-radius: var(--radius-sm);
            margin-bottom: 10px;
            border: 1px solid #e0e0e0;
        }

        .temp-expense-label {
            font-size: 13px;
            font-weight: 600;
            margin: 0 0 8px 0;
            color: #333;
        }

        /* çµæœè¡¨ç¤º */
        .results {
            display: none;
            margin-top: 40px;
        }

        .results.show {
            display: block;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #ff5757;
        }

        .summary-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 6px;
            font-weight: 600;
        }

        .summary-value {
            font-size: 22px;
            font-weight: 700;
            color: #ff5757;
        }

        .summary-value.warning {
            color: #ff6b6b;
        }

        .summary-value.good {
            color: #28a745;
        }

        .summary-value.bad {
            color: #dc3545;
            font-weight: 800;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            border-bottom: 2px solid #e0e0e0;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
        }

        .tab.active {
            color: #ff5757;
            border-bottom-color: #ff5757;
        }

        .tab:hover {
            color: #ff5757;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .chart-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border: 1px solid #e0e0e0;
        }

        .chart-title {
            font-size: 20px;
            font-weight: 700;
            color: #222;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px solid #ff5757;
            text-align: left;
        }

        .chart-wrapper {
            position: relative;
            height: 450px;
            background: #fafafa;
            padding: 20px;
            border-radius: 10px;
        }

        .alert-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .alert-box.success {
            background: #d4edda;
            border-left-color: #28a745;
        }

        .alert-box p {
            color: #856404;
            font-size: 15px;
            line-height: 1.6;
            margin-bottom: 8px;
        }

        .alert-box.success p {
            color: #155724;
        }

        .download-btn {
            padding: 12px 24px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 15px;
        }

        .download-btn:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .table-container {
            overflow-x: auto;
            margin-top: 15px;
        }

        table {
            width: 100%;
            min-width: 1200px;
            border-collapse: collapse;
            background: white;
            font-size: 12px;
        }

        th, td {
            padding: 8px 6px;
            text-align: right;
            border-bottom: 1px solid #e0e0e0;
            white-space: nowrap;
        }

        th {
            background: #1a3a5c;
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .year-column {
            text-align: center;
            font-weight: 600;
            position: sticky;
            left: 0;
            background: white;
            z-index: 5;
        }

        th.year-column {
            z-index: 15;
            background: #1a3a5c;
        }

        tr:hover td {
            background: #f8f9fa;
        }

        @media (max-width: 768px) {
            .content {
                padding: 20px;
            }

            .input-row {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .preset-buttons {
                flex-direction: column;
            }

            .preset-btn {
                width: 100%;
            }

            .summary-cards {
                grid-template-columns: 1fr;
            }

            .tabs {
                overflow-x: auto;
            }

            .chart-wrapper {
                height: 300px;
            }
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #1a3a5c;
            font-weight: 600;
        }

        /* æ¯”è¼ƒãƒ¢ãƒ¼ãƒ‰ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .comparison-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding: 15px;
            background: #e3f2fd;
            border-radius: 10px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider-switch {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .slider-switch:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider-switch {
            background-color: #1a3a5c;
        }

        input:checked + .slider-switch:before {
            transform: translateX(26px);
        }

        .comparison-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .comparison-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            border: 2px solid #e0e0e0;
        }

        .comparison-section.winner {
            border-color: #28a745;
            background: #d4edda;
        }

        .comparison-title {
            font-size: 18px;
            font-weight: 700;
            color: #333;
            margin-bottom: 15px;
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 2px solid #1a3a5c;
        }

        .comparison-result {
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            text-align: center;
        }

        .winner-badge {
            display: inline-block;
            padding: 8px 16px;
            background: #28a745;
            color: white;
            border-radius: 20px;
            font-weight: 700;
            font-size: 14px;
            margin-bottom: 10px;
        }

        @media (max-width: 768px) {
            .comparison-container {
                grid-template-columns: 1fr;
            }
        }

        /* ãƒªã‚¹ã‚¯ä¿¡å·æ©Ÿ â†’ ã‚·ãƒ³ãƒ—ãƒ«ã‚«ãƒ¼ãƒ‰ */
        .risk-indicator {
            display: none;
            padding: 25px 30px;
            background: white;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-left: 6px solid #ccc;
            transition: all 0.3s;
        }

        .risk-indicator.risk-high {
            border-left-color: #1a3a5c;
            background: linear-gradient(135deg, #fff5f5 0%, #ffffff 100%);
        }

        .risk-indicator.risk-medium {
            border-left-color: #ffc107;
            background: linear-gradient(135deg, #fffbf0 0%, #ffffff 100%);
        }

        .risk-indicator.risk-low {
            border-left-color: #28a745;
            background: linear-gradient(135deg, #f0fff4 0%, #ffffff 100%);
        }

        .risk-content {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .risk-icon {
            font-size: 48px;
            line-height: 1;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }

        .risk-text {
            flex: 1;
        }

        .risk-title {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .risk-description {
            font-size: 15px;
            color: #666;
            line-height: 1.6;
        }

        @media (max-width: 768px) {
            .risk-content {
                flex-direction: column;
                text-align: center;
            }

            .risk-icon {
                font-size: 64px;
            }
        }

        /* ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ */
        .timeline-container {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .timeline-title {
            font-size: 20px;
            font-weight: 700;
            color: #333;
            margin-bottom: 25px;
            text-align: center;
        }

        .timeline {
            position: relative;
            padding: 30px 0;
        }

        .timeline-line {
            position: absolute;
            top: 25px;
            left: 0;
            right: 0;
            height: 6px;
            background: linear-gradient(to right, #c0392b, #c49b5a, #28a745);
            border-radius: 3px;
        }

        .timeline-events {
            display: flex;
            justify-content: space-between;
            position: relative;
            z-index: 1;
        }

        .timeline-event {
            text-align: center;
            flex: 1;
            position: relative;
        }

        .timeline-marker {
            width: 24px;
            height: 24px;
            background: #1a3a5c;
            border: 4px solid white;
            border-radius: 50%;
            margin: 0 auto 15px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            transition: all 0.3s;
        }

        .timeline-event:hover .timeline-marker {
            transform: scale(1.3);
        }

        .timeline-label {
            font-size: 13px;
            font-weight: 600;
            color: #333;
            line-height: 1.4;
            padding: 8px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }

        .timeline-year {
            color: #1a3a5c;
            font-weight: 700;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            animation: fadeIn 0.3s;
        }

        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 40px;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
            color: #333;
        }

        .modal-close {
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            color: #999;
            line-height: 1;
            transition: all 0.3s;
        }

        .modal-close:hover {
            color: #333;
            transform: rotate(90deg);
        }

        .share-url-container {
            margin-bottom: 25px;
        }

        .share-url-label {
            font-size: 14px;
            font-weight: 600;
            color: #666;
            margin-bottom: 10px;
        }

        .share-url {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
            font-family: monospace;
            background: #f8f9fa;
        }

        .share-url:focus {
            outline: none;
            border-color: #1a3a5c;
        }

        .copy-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #1a3a5c 0%, #2c5f8a 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(26, 58, 92, 0.3);
        }

        .copy-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(26, 58, 92, 0.4);
        }

        .copy-btn:active {
            transform: translateY(0);
        }

        .copy-success {
            text-align: center;
            color: #28a745;
            font-weight: 600;
            margin-top: 15px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .copy-success.show {
            opacity: 1;
        }

        @media (max-width: 768px) {
            .share-btn {
                position: static;
                margin-top: 20px;
                display: inline-block;
            }

            .timeline-events {
                flex-direction: column;
                gap: 30px;
            }

            .timeline-line {
                left: 50%;
                top: 0;
                bottom: 0;
                width: 6px;
                height: auto;
                background: linear-gradient(to bottom, #c0392b, #c49b5a, #28a745);
            }

            .risk-indicator {
                flex-direction: column;
            }

            .traffic-light {
                flex-direction: row;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo"><img src="MIKATA_10.png" alt="MIKATA" style="height: 50px; filter: brightness(0) invert(1);"></div>
            <h1>ä½å®…è³¼å…¥ãƒ©ã‚¤ãƒ•ãƒ—ãƒ©ãƒ³ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</h1>
            <p>ã”å®¶æ—ã®æœªæ¥ã‚’æ•°å­—ã§ã€Œè¦‹ãˆã‚‹åŒ–ã€â”€â”€ 60å¹´é–“ã®å®¶è¨ˆã‚’å …å®Ÿã«ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</p>
            <button class="share-btn" onclick="openShareModal()">ğŸ”— è¨­å®šã‚’å…±æœ‰</button>
        </div>

        <div class="content">

            <!-- ç°¡æ˜“å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
            <div class="simple-input">
                <div class="section-title">
                    âœï¸ åŸºæœ¬æƒ…å ±ï¼ˆå¿…é ˆå…¥åŠ›ï¼‰
                </div>

                <div class="input-row">
                    <div class="input-group">
                        <div class="input-label">
                            æœ¬äººã®å¹´é½¢
                            <span class="help-icon" data-tip="ç¾åœ¨ã®å¹´é½¢ã‚’å…¥åŠ›">?</span>
                        </div>
                        <div class="input-wrapper">
                            <input type="range" id="person1Age" min="20" max="70" value="35" oninput="updateSlider('person1Age')">
                            <span class="slider-value" id="person1AgeValue">35æ­³</span>
                        </div>
                    </div>

                    <div class="input-group">
                        <div class="input-label">
                            é…å¶è€…ã®å¹´é½¢
                            <span class="help-icon" data-tip="é…å¶è€…ãŒã„ãªã„å ´åˆã¯0">?</span>
                        </div>
                        <div class="input-wrapper">
                            <input type="range" id="person2Age" min="0" max="70" value="33" oninput="updateSlider('person2Age')">
                            <span class="slider-value" id="person2AgeValue">33æ­³</span>
                        </div>
                    </div>
                </div>

                <div class="input-row">
                    <div class="input-group">
                        <div class="input-label">
                            ä¸–å¸¯å¹´å
                            <span class="help-icon" data-tip="æœ¬äººã¨é…å¶è€…ã®å¹´ååˆè¨ˆ">?</span>
                        </div>
                        <div class="input-wrapper">
                            <input type="range" id="totalIncome" min="200" max="2000" value="800" step="50" oninput="updateSlider('totalIncome')">
                            <span class="slider-value" id="totalIncomeValue">800ä¸‡å††</span>
                        </div>
                    </div>

                </div>

                <div class="input-row">
                    <div class="input-group">
                        <div class="input-label">
                            ç‰©ä»¶ä¾¡æ ¼
                            <span class="help-icon" data-tip="è³¼å…¥ã‚’æ¤œè¨ã—ã¦ã„ã‚‹ç‰©ä»¶ã®ä¾¡æ ¼">?</span>
                        </div>
                        <div class="input-wrapper">
                            <input type="range" id="propertyPrice" min="2000" max="10000" value="5000" step="100" oninput="updateSlider('propertyPrice')">
                            <span class="slider-value" id="propertyPriceValue">5000ä¸‡å††</span>
                        </div>
                    </div>

                    <div class="input-group">
                        <div class="input-label">
                            é ­é‡‘
                            <span class="help-icon" data-tip="è³¼å…¥æ™‚ã«ç”¨æ„ã§ãã‚‹ç¾é‡‘">?</span>
                        </div>
                        <div class="input-wrapper">
                            <input type="range" id="downPayment" min="0" max="3000" value="500" step="50" oninput="updateSlider('downPayment')">
                            <span class="slider-value" id="downPaymentValue">500ä¸‡å††</span>
                        </div>
                    </div>
                </div>

            </div>

            <input type="hidden" id="numChildren" value="2">

            <!-- ã‚»ãƒ‘ãƒ¬ãƒ¼ã‚¿ãƒ¼ -->
            <div class="advanced-divider">
                <div class="advanced-divider-line"></div>
                <div class="advanced-divider-label">
                    è©³ç´°è¨­å®šï¼ˆä»»æ„ï¼‰
                    <span class="advanced-divider-sublabel">åŸºæœ¬æƒ…å ±ã ã‘ã§ã‚‚ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ãã¾ã™</span>
                </div>
                <div class="advanced-divider-line"></div>
            </div>

            <!-- è©³ç´°è¨­å®š -->
            <div class="advanced-settings-container">
                <!-- åå…¥è©³ç´° -->
                <div class="advanced-section">
                    <div class="accordion-header" onclick="toggleAccordion(this)">
                        <div class="advanced-section-title">ğŸ’µ åå…¥ã®è©³ç´°è¨­å®š</div>
                        <span class="accordion-chevron">â–¾</span>
                    </div>
                    <div class="accordion-body">
                    <div class="accordion-body-inner">
                    <div class="info-box">
                        <p style="font-size: 13px; color: #333; margin: 0; line-height: 1.6;">
                            ğŸ’¡ <strong>å¹´åã¯é¡é¢ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</strong>ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯è‡ªå‹•çš„ã«ç¨é‡‘ãƒ»ç¤¾ä¼šä¿é™ºæ–™ï¼ˆç´„25-30%ï¼‰ã‚’æ§é™¤ã—ãŸæ‰‹å–ã‚Šé¡ã§è¨ˆç®—ã•ã‚Œã¾ã™ã€‚
                        </p>
                        <p style="font-size: 12px; color: #666; margin: 5px 0 0 0;">
                            ä¾‹ï¼šå¹´å500ä¸‡å†† â†’ æ‰‹å–ã‚Šç´„380ä¸‡å††ã€å¹´å800ä¸‡å†† â†’ æ‰‹å–ã‚Šç´„590ä¸‡å††
                        </p>
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <div class="input-label">æœ¬äººã®å¹´åï¼ˆé¡é¢ï¼‰</div>
                            <div class="input-wrapper">
                                <input type="number" id="person1Income" value="500" step="10" oninput="syncTotalIncome()">
                                <span class="unit-label">ä¸‡å††</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <div class="input-label">é…å¶è€…ã®å¹´åï¼ˆé¡é¢ï¼‰</div>
                            <div class="input-wrapper">
                                <input type="number" id="person2Income" value="300" step="10" oninput="syncTotalIncome(); syncWorkPatternIncome()">
                                <span class="unit-label">ä¸‡å††</span>
                            </div>
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <div class="input-label">æœ¬äººã®æ˜‡çµ¦ç‡ï¼ˆå¹´é–“ï¼‰</div>
                            <div class="input-wrapper">
                                <input type="number" id="person1Growth" value="1.5" step="0.1">
                                <span class="unit-label">%</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <div class="input-label">é…å¶è€…ã®æ˜‡çµ¦ç‡ï¼ˆå¹´é–“ï¼‰</div>
                            <div class="input-wrapper">
                                <input type="number" id="person2Growth" value="1.0" step="0.1">
                                <span class="unit-label">%</span>
                            </div>
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <div class="input-label">æœ¬äººã®å®šå¹´</div>
                            <div class="input-wrapper">
                                <input type="number" id="person1Retire" value="65" min="50" max="80">
                                <span class="unit-label">æ­³</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <div class="input-label">é…å¶è€…ã®å®šå¹´</div>
                            <div class="input-wrapper">
                                <input type="number" id="person2Retire" value="65" min="50" max="80">
                                <span class="unit-label">æ­³</span>
                            </div>
                        </div>
                    </div>
                    <div class="advanced-section-title" style="margin-top: 20px; border-top: 2px solid #e0e0e0; padding-top: 15px;">
                        ğŸ‘©â€ğŸ’¼ é…å¶è€…ã®å°±åŠ´ãƒ‘ã‚¿ãƒ¼ãƒ³
                    </div>
                    <p style="font-size: 13px; color: #666; margin: 0 0 12px 0;">
                        ğŸ’¡ æ™‚ç³»åˆ—ã§å°±åŠ´å½¢æ…‹ã‚’è¨­å®šã§ãã¾ã™ï¼ˆè¤‡æ•°ãƒ‘ã‚¿ãƒ¼ãƒ³è¿½åŠ å¯èƒ½ï¼‰
                    </p>
                    <div id="person2WorkPatternsContainer">
                        <div class="other-loan-item person2-work-pattern" data-pattern-index="0" style="margin-bottom: 12px; padding: 12px; background: #f5f7fa; border-radius: 8px; border-left: 3px solid #2c5f8a;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <span style="font-weight: 600; font-size: 14px; color: #1a3a5c;">ãƒ‘ã‚¿ãƒ¼ãƒ³1</span>
                            </div>
                            <div class="input-row" style="margin-bottom: 6px;">
                                <div class="input-group">
                                    <div class="input-label">å°±åŠ´å½¢æ…‹</div>
                                    <div class="input-wrapper">
                                        <select class="workPatternType">
                                            <option value="fulltime" selected>ãƒ•ãƒ«ã‚¿ã‚¤ãƒ </option>
                                            <option value="parttime">ãƒ‘ãƒ¼ãƒˆãƒ»æ™‚çŸ­å‹¤å‹™</option>
                                            <option value="homemaker">å°‚æ¥­ä¸»å©¦ï¼ˆä¸»å¤«ï¼‰</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="input-group">
                                    <div class="input-label">å¹´åï¼ˆé¡é¢ï¼‰</div>
                                    <div class="input-wrapper">
                                        <input type="number" class="workPatternIncome" value="300" step="10" min="0">
                                        <span class="unit-label">ä¸‡å††</span>
                                    </div>
                                </div>
                            </div>
                            <div class="input-row">
                                <div class="input-group">
                                    <div class="input-label">é–‹å§‹</div>
                                    <div class="input-wrapper">
                                        <input type="number" class="workPatternStart" value="0" min="0" max="60">
                                        <span class="unit-label">å¹´å¾Œ</span>
                                    </div>
                                </div>
                                <div class="input-group">
                                    <div class="input-label">çµ‚äº†</div>
                                    <div class="input-wrapper">
                                        <input type="number" class="workPatternEnd" value="30" min="0" max="60">
                                        <span class="unit-label">å¹´å¾Œ</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button type="button" onclick="addWorkPattern()" style="background: #2c5f8a; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; margin-bottom: 15px;">
                        ï¼‹ ãƒ‘ã‚¿ãƒ¼ãƒ³è¿½åŠ 
                    </button>
                    <!-- å¾Œæ–¹äº’æ›ç”¨ã®éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ -->
                    <input type="hidden" id="person2WorkType" value="fulltime">
                    <input type="hidden" id="person2WorkStart" value="0">
                    <input type="hidden" id="person2WorkEnd" value="30">
                    <input type="hidden" id="person2PartIncome" value="120">
                    <div class="input-row">
                        <div class="input-group">
                            <div class="input-label">æœ¬äººã®å¹´é‡‘ï¼ˆå¹´é–“ï¼‰</div>
                            <div class="input-wrapper">
                                <input type="number" id="person1Pension" value="200" step="10">
                                <span class="unit-label">ä¸‡å††</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <div class="input-label">é…å¶è€…ã®å¹´é‡‘ï¼ˆå¹´é–“ï¼‰</div>
                            <div class="input-wrapper">
                                <input type="number" id="person2Pension" value="150" step="10">
                                <span class="unit-label">ä¸‡å††</span>
                            </div>
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <div class="input-label">æœ¬äººã®é€€è·é‡‘</div>
                            <div class="input-wrapper">
                                <input type="number" id="person1Retirement" value="2000" step="100">
                                <span class="unit-label">ä¸‡å††</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <div class="input-label">é…å¶è€…ã®é€€è·é‡‘</div>
                            <div class="input-wrapper">
                                <input type="number" id="person2Retirement" value="1500" step="100">
                                <span class="unit-label">ä¸‡å††</span>
                            </div>
                        </div>
                    </div>
                    
                    </div><!-- accordion-body-inner -->
                    </div><!-- accordion-body -->
                </div>

                <!-- ä½å®…ãƒ­ãƒ¼ãƒ³è©³ç´° -->
                <div class="advanced-section">
                    <div class="accordion-header" onclick="toggleAccordion(this)">
                        <div class="advanced-section-title">ğŸ  ä½å®…ãƒ­ãƒ¼ãƒ³ã®è©³ç´°è¨­å®š</div>
                        <span class="accordion-chevron">â–¾</span>
                    </div>
                    <div class="accordion-body">
                    <div class="accordion-body-inner">
                    <!-- æ¯”è¼ƒãƒ¢ãƒ¼ãƒ‰ãƒˆã‚°ãƒ« -->
                    <div class="comparison-toggle">
                        <label class="switch">
                            <input type="checkbox" id="compareRates" onchange="toggleComparisonMode()">
                            <span class="slider-switch"></span>
                        </label>
                        <span style="font-weight: 600;">å¤‰å‹•é‡‘åˆ© vs å›ºå®šé‡‘åˆ© æ¯”è¼ƒãƒ¢ãƒ¼ãƒ‰</span>
                    </div>

                    <!-- é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ -->
                    <div id="normalRateMode">
                        <div class="input-row">
                            <div class="input-group">
                                <div class="input-label">
                                    è¿”æ¸ˆæ–¹æ³•
                                    <span class="help-icon" data-tip="å…ƒåˆ©é‡‘ç­‰ã¯æ¯æœˆä¸€å®šã€å…ƒé‡‘å‡ç­‰ã¯åˆæœŸè² æ‹…å¤§">?</span>
                                </div>
                                <div class="input-wrapper">
                                    <select id="repaymentMethod">
                                        <option value="equal_payment" selected>å…ƒåˆ©é‡‘ç­‰ï¼ˆæ¯æœˆä¸€å®šï¼‰</option>
                                        <option value="equal_principal">å…ƒé‡‘å‡ç­‰ï¼ˆåˆæœŸå¤šã‚ï¼‰</option>
                                    </select>
                                </div>
                            </div>
                            <div class="input-group">
                                <div class="input-label">é‡‘åˆ©ï¼ˆå¹´åˆ©ï¼‰</div>
                                <div class="input-wrapper">
                                    <input type="number" id="interestRate" value="1.5" step="0.1">
                                    <span class="unit-label">%</span>
                                </div>
                            </div>
                        </div>
                        <div class="input-row">
                            <div class="input-group">
                                <div class="input-label">è¿”æ¸ˆæœŸé–“</div>
                                <div class="input-wrapper">
                                    <select id="loanTerm">
                                        <option value="10">10å¹´</option>
                                        <option value="15">15å¹´</option>
                                        <option value="20">20å¹´</option>
                                        <option value="25">25å¹´</option>
                                        <option value="30">30å¹´</option>
                                        <option value="35" selected>35å¹´</option>
                                        <option value="40">40å¹´</option>
                                        <option value="45">45å¹´</option>
                                        <option value="50">50å¹´</option>
                                    </select>
                                </div>
                            </div>
                            <div class="input-group"></div>
                        </div>
                        <div style="background: #fff3e0; padding: 12px; border-radius: 8px; margin-top: 15px;">
                            <p style="font-size: 13px; color: #666; margin: 0; line-height: 1.5;">
                                ğŸ’¡ <strong>å…ƒåˆ©é‡‘ç­‰ï¼š</strong>æ¯æœˆã®è¿”æ¸ˆé¡ãŒä¸€å®šã€‚è¨ˆç”»ãŒç«‹ã¦ã‚„ã™ã„ã€‚<br>
                                <strong>å…ƒé‡‘å‡ç­‰ï¼š</strong>åˆæœŸã®è¿”æ¸ˆé¡ã¯å¤šã„ãŒã€ç·è¿”æ¸ˆé¡ã¯å°‘ãªã‚ã€‚
                            </p>
                        </div>
                    </div>

                    <!-- æ¯”è¼ƒãƒ¢ãƒ¼ãƒ‰ -->
                    <div id="comparisonRateMode" style="display: none;">
                        <div class="input-row">
                            <div class="input-group">
                                <div class="input-label">å›ºå®šé‡‘åˆ©ï¼ˆå¹´åˆ©ï¼‰</div>
                                <div class="input-wrapper">
                                    <input type="number" id="fixedRate" value="2.0" step="0.1">
                                    <span class="unit-label">%</span>
                                </div>
                            </div>
                            <div class="input-group">
                                <div class="input-label">å¤‰å‹•é‡‘åˆ©ï¼ˆåˆæœŸå¹´åˆ©ï¼‰</div>
                                <div class="input-wrapper">
                                    <input type="number" id="variableRate" value="1.0" step="0.1">
                                    <span class="unit-label">%</span>
                                </div>
                            </div>
                        </div>
                        <div class="input-row">
                            <div class="input-group">
                                <div class="input-label">å¤‰å‹•é‡‘åˆ©ã‚·ãƒŠãƒªã‚ª</div>
                                <div class="input-wrapper">
                                    <select id="rateScenario" onchange="updateScenarioDescription()">
                                        <option value="optimistic">æ¥½è¦³ã‚·ãƒŠãƒªã‚ªï¼ˆã»ã¼æ¨ªã°ã„ï¼‰</option>
                                        <option value="standard" selected>æ¨™æº–ã‚·ãƒŠãƒªã‚ªï¼ˆç·©ã‚„ã‹ãªä¸Šæ˜‡ï¼‰</option>
                                        <option value="pessimistic">æ‚²è¦³ã‚·ãƒŠãƒªã‚ªï¼ˆæ€¥æ¿€ãªä¸Šæ˜‡ï¼‰</option>
                                    </select>
                                </div>
                            </div>
                            <div class="input-group">
                                <div class="input-label">è¿”æ¸ˆæœŸé–“</div>
                                <div class="input-wrapper">
                                    <select id="loanTermCompare">
                                        <option value="10">10å¹´</option>
                                        <option value="15">15å¹´</option>
                                        <option value="20">20å¹´</option>
                                        <option value="25">25å¹´</option>
                                        <option value="30">30å¹´</option>
                                        <option value="35" selected>35å¹´</option>
                                        <option value="40">40å¹´</option>
                                        <option value="45">45å¹´</option>
                                        <option value="50">50å¹´</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-top: 15px;">
                            <p id="scenarioDescription" style="font-size: 14px; color: #333; line-height: 1.6; margin: 0;"></p>
                        </div>
                    </div>

                    <div class="input-row">
                        <div class="input-group">
                            <div class="input-label">è³¼å…¥æ™‚æœŸ</div>
                            <div class="input-wrapper">
                                <input type="number" id="loanStartYear" value="1" min="0" max="20">
                                <span class="unit-label">å¹´å¾Œ</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <div class="input-label">å›ºå®šè³‡ç”£ç¨ï¼ˆå¹´é–“ï¼‰</div>
                            <div class="input-wrapper">
                                <input type="number" id="propertyTax" value="15" step="1">
                                <span class="unit-label">ä¸‡å††</span>
                            </div>
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <div class="input-label">ä½å®…ãƒ­ãƒ¼ãƒ³æ§é™¤ï¼ˆå¹´é–“ï¼‰</div>
                            <div class="input-wrapper">
                                <input type="number" id="loanDeduction" value="25" step="5">
                                <span class="unit-label">ä¸‡å††</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <div class="input-label">ç¾åœ¨ã®å®¶è³ƒï¼ˆæœˆé¡ï¼‰</div>
                            <div class="input-wrapper">
                                <input type="number" id="currentRent" value="12" step="1">
                                <span class="unit-label">ä¸‡å††</span>
                            </div>
                        </div>
                    </div>

                    <!-- ç«ç½ä¿é™º -->
                    <div class="input-row">
                        <div class="input-group">
                            <div class="input-label">
                                ç«ç½ä¿é™ºï¼ˆ5å¹´åˆ†ï¼‰
                                <span class="help-icon" data-tip="5å¹´ã”ã¨ã«æ›´æ–°ã•ã‚Œã‚‹ç«ç½ä¿é™ºæ–™">?</span>
                            </div>
                            <div class="input-wrapper">
                                <input type="number" id="fireInsurance" value="20" step="5">
                                <span class="unit-label">ä¸‡å††</span>
                            </div>
                        </div>
                        <div class="input-group"></div>
                    </div>
                    <div style="background: #fff3e0; padding: 12px; border-radius: 8px; margin-top: 15px;">
                        <p style="font-size: 13px; color: #666; margin: 0; line-height: 1.5;">
                            ğŸ’¡ ç«ç½ä¿é™ºã¯è³¼å…¥æ™‚ã¨5å¹´ã”ã¨ï¼ˆè³¼å…¥5å¹´å¾Œã€10å¹´å¾Œ...ï¼‰ã«æ”¯æ‰•ã„ãŒç™ºç”Ÿã—ã¾ã™ã€‚
                        </p>
                    </div>

                    <!-- ç‰©ä»¶ä¾¡æ ¼ã®å†…è¨³ -->
                    <div class="advanced-section-title" style="margin-top: 30px; border-top: 2px solid #e0e0e0; padding-top: 20px;">
                        ğŸ—ï¸ ç‰©ä»¶ä¾¡æ ¼ã®å†…è¨³
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <div class="input-label">
                                åœŸåœ°ä¾¡æ ¼
                                <span class="help-icon" data-tip="åœŸåœ°ã®ã¿ã®ä¾¡æ ¼">?</span>
                            </div>
                            <div class="input-wrapper">
                                <input type="number" id="landPrice" value="2000" step="100" oninput="updateTotalPrice()">
                                <span class="unit-label">ä¸‡å††</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <div class="input-label">
                                å»ºç‰©ä¾¡æ ¼
                                <span class="help-icon" data-tip="å»ºç‰©æœ¬ä½“ã®ä¾¡æ ¼">?</span>
                            </div>
                            <div class="input-wrapper">
                                <input type="number" id="buildingPrice" value="3000" step="100" oninput="updateTotalPrice()">
                                <span class="unit-label">ä¸‡å††</span>
                            </div>
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <div class="input-label">
                                è«¸è²»ç”¨
                                <span class="help-icon" data-tip="ç™»è¨˜è²»ç”¨ã€ä»²ä»‹æ‰‹æ•°æ–™ç­‰">?</span>
                            </div>
                            <div class="input-wrapper">
                                <input type="number" id="additionalCost" value="200" step="50" oninput="updateTotalPrice()">
                                <span class="unit-label">ä¸‡å††</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <div class="input-label" style="font-weight: 700; color: #1a3a5c;">
                                ç·é¡ï¼ˆè‡ªå‹•è¨ˆç®—ï¼‰
                            </div>
                            <div class="input-wrapper">
                                <input type="number" id="totalPriceCalc" value="5200" readonly style="background: #f8f9fa; font-weight: 700; color: #1a3a5c;">
                                <span class="unit-label">ä¸‡å††</span>
                            </div>
                        </div>
                    </div>
                    <div style="background: #fff3e0; padding: 12px; border-radius: 8px; margin-top: 15px;">
                        <p style="font-size: 13px; color: #666; margin: 0; line-height: 1.5;">
                            ğŸ’¡ ã“ã®ç·é¡ãŒã€Œç‰©ä»¶ä¾¡æ ¼ã€ã¨ã—ã¦ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚ç°¡æ˜“å…¥åŠ›ã®ç‰©ä»¶ä¾¡æ ¼ã¨é€£å‹•ã—ã¦ã„ã¾ã™ã€‚
                        </p>
                    </div>
                    
                    <!-- é•·æœŸå„ªè‰¯ä½å®… -->
                    <div class="advanced-section-title" style="margin-top: 30px; border-top: 2px solid #e0e0e0; padding-top: 20px;">
                        â­ é•·æœŸå„ªè‰¯ä½å®…ãƒ»ç¨åˆ¶å„ªé‡
                    </div>
                    <div class="comparison-toggle">
                        <label class="switch">
                            <input type="checkbox" id="isLongTerm" onchange="updateLongTermBenefits()">
                            <span class="slider-switch"></span>
                        </label>
                        <span style="font-weight: 600;">é•·æœŸå„ªè‰¯ä½å®…ã®èªå®šã‚’å—ã‘ã‚‹</span>
                    </div>
                    <div id="longTermBenefits" style="display: none; margin-top: 15px;">
                        <div style="background: #e8f5e9; padding: 15px; border-radius: 8px;">
                            <p style="font-size: 14px; color: #333; margin: 0 0 10px 0; font-weight: 600;">
                                âœ… å—ã‘ã‚‰ã‚Œã‚‹å„ªé‡æªç½®ï¼š
                            </p>
                            <ul style="font-size: 13px; color: #666; margin: 0; padding-left: 20px; line-height: 1.8;">
                                <li>ä½å®…ãƒ­ãƒ¼ãƒ³æ§é™¤ã®å€Ÿå…¥é™åº¦é¡UPï¼ˆä¸€èˆ¬ä½å®…3,000ä¸‡å†† â†’ 5,000ä¸‡å††ï¼‰</li>
                                <li>ç™»éŒ²å…è¨±ç¨ã®è»½æ¸›ï¼ˆä¿å­˜ç™»è¨˜0.15% â†’ 0.1%ã€ç§»è»¢ç™»è¨˜0.3% â†’ 0.2%ï¼‰</li>
                                <li>ä¸å‹•ç”£å–å¾—ç¨ã®è»½æ¸›ï¼ˆæ§é™¤é¡1,200ä¸‡å†† â†’ 1,300ä¸‡å††ï¼‰</li>
                                <li>å›ºå®šè³‡ç”£ç¨ã®æ¸›é¡æœŸé–“å»¶é•·ï¼ˆ3å¹´ â†’ 5å¹´ã€ãƒãƒ³ã‚·ãƒ§ãƒ³ã¯5å¹´ â†’ 7å¹´ï¼‰</li>
                            </ul>
                        </div>
                        <div class="input-row" style="margin-top: 15px;">
                            <div class="input-group">
                                <div class="input-label">
                                    ç™»è¨˜ãƒ»ç¨é‡‘ã®è«¸è²»ç”¨å‰Šæ¸›
                                    <span class="help-icon" data-tip="åˆå¹´åº¦ã«å—ã‘ã‚‰ã‚Œã‚‹è»½æ¸›é¡">?</span>
                                </div>
                                <div class="input-wrapper">
                                    <input type="number" id="longTermTaxSaving" value="30" step="5">
                                    <span class="unit-label">ä¸‡å††</span>
                                </div>
                            </div>
                            <div class="input-group">
                                <div class="input-label">
                                    å›ºå®šè³‡ç”£ç¨ã®æ¸›ç¨æœŸé–“
                                    <span class="help-icon" data-tip="ä¸€èˆ¬3å¹´â†’é•·æœŸå„ªè‰¯5å¹´">?</span>
                                </div>
                                <div class="input-wrapper">
                                    <input type="number" id="taxReductionYears" value="5" min="3" max="7">
                                    <span class="unit-label">å¹´</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    </div><!-- accordion-body-inner -->
                    </div><!-- accordion-body -->
                </div>

                <!-- ç”Ÿæ´»è²» -->
                <div class="advanced-section">
                    <div class="accordion-header" onclick="toggleAccordion(this)">
                        <div class="advanced-section-title">ğŸ›’ ç”Ÿæ´»è²»ã®è¨­å®š</div>
                        <span class="accordion-chevron">â–¾</span>
                    </div>
                    <div class="accordion-body">
                    <div class="accordion-body-inner">
                    <div class="input-row">
                        <div class="input-group">
                            <div class="input-label">åŸºæœ¬ç”Ÿæ´»è²»ï¼ˆæœˆé¡ï¼‰</div>
                            <div class="input-wrapper">
                                <input type="number" id="basicLiving" value="20" step="1">
                                <span class="unit-label">ä¸‡å††</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <div class="input-label">
                                ç‰©ä¾¡ä¸Šæ˜‡ç‡ï¼ˆå¹´é–“ï¼‰
                                <span class="help-icon" data-tip="ç”Ÿæ´»è²»å…¨ä½“ã®ä¸Šæ˜‡ç‡ï¼ˆã‚¤ãƒ³ãƒ•ãƒ¬ç‡ï¼‰">?</span>
                            </div>
                            <div class="input-wrapper">
                                <input type="number" id="inflationRate" value="0" step="0.1">
                                <span class="unit-label">%</span>
                            </div>
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <div class="input-label">è»Šä¸¡è²»ï¼ˆå¹´é–“ï¼‰</div>
                            <div class="input-wrapper">
                                <input type="number" id="carCost" value="30" step="5">
                                <span class="unit-label">ä¸‡å††</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <div class="input-label">é€šä¿¡è²»ï¼ˆæœˆé¡ï¼‰</div>
                            <div class="input-wrapper">
                                <input type="number" id="communication" value="2" step="0.5">
                                <span class="unit-label">ä¸‡å††</span>
                            </div>
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <div class="input-label">ãŠã“ã¥ã‹ã„ï¼ˆæœˆé¡ï¼‰</div>
                            <div class="input-wrapper">
                                <input type="number" id="allowance" value="3" step="0.5">
                                <span class="unit-label">ä¸‡å††</span>
                            </div>
                        </div>
                        <div class="input-group"></div>
                    </div>

                    <!-- ãã®ä»–ãƒ­ãƒ¼ãƒ³ï¼ˆè¤‡æ•°å¯¾å¿œï¼‰ -->
                    <div style="margin-top: 20px; border-top: 2px solid #e0e0e0; padding-top: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <div class="input-label" style="margin-bottom: 0;">ãã®ä»–ãƒ­ãƒ¼ãƒ³</div>
                            <button type="button" onclick="addOtherLoan()" style="padding: 6px 16px; background: #ff5757; color: white; border: none; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer;">ï¼‹ è¿½åŠ </button>
                        </div>
                        <div id="otherLoansContainer">
                            <div class="other-loan-item" data-loan-index="0" style="background: white; padding: 12px; border-radius: 8px; margin-bottom: 8px; border: 1px solid #e0e0e0;">
                                <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                                    <input type="text" class="otherLoanName" value="è»Šãƒ­ãƒ¼ãƒ³" placeholder="åç§°" style="width: 100px; padding: 8px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                                    <input type="number" class="otherLoanAmount" value="0" step="0.5" min="0" style="width: 80px; padding: 8px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                                    <span style="font-size: 13px; color: #666;">ä¸‡å††/æœˆ</span>
                                    <span style="font-size: 13px; color: #666; margin-left: 8px;">æ®‹ã‚Š</span>
                                    <input type="number" class="otherLoanYears" value="0" step="1" min="0" max="50" style="width: 60px; padding: 8px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                                    <span style="font-size: 13px; color: #666;">å¹´</span>
                                </div>
                            </div>
                        </div>
                        <p style="font-size: 12px; color: #999; margin-top: 8px;">
                            ğŸ’¡ ãƒ­ãƒ¼ãƒ³æœŸé–“ã‚’0ã«ã™ã‚‹ã¨ã€ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å…¨æœŸé–“ã§æ”¯æ‰•ã„ãŒç¶šãã¾ã™
                        </p>
                    </div>
                    </div><!-- accordion-body-inner -->
                    </div><!-- accordion-body -->
                </div>

                <!-- å­ã©ã‚‚è¨­å®šï¼ˆçµ±åˆï¼‰ -->
                <div class="advanced-section">
                    <div class="accordion-header" onclick="toggleAccordion(this)">
                        <div class="advanced-section-title">ğŸ‘¶ å­ã©ã‚‚è¨­å®š</div>
                        <span class="accordion-chevron">â–¾</span>
                    </div>
                    <div class="accordion-body">
                    <div class="accordion-body-inner">
                    <p style="font-size: 13px; color: #666; margin: 0 0 15px 0;">
                        ğŸ’¡ å¹´é½¢ãŒãƒã‚¤ãƒŠã‚¹ï¼ˆå‡ºç”£äºˆå®šï¼‰ã®å ´åˆã€ç”£ä¼‘ãƒ»è‚²ä¼‘è¨­å®šãŒè¡¨ç¤ºã•ã‚Œã¾ã™
                    </p>

                    <!-- å­ã©ã‚‚1 -->
                    <div id="child1UnifiedSection" class="child-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <p class="child-section-label" style="margin: 0;">
                                å­ã©ã‚‚1
                                <span id="child1StatusBadge" style="font-size: 12px; padding: 2px 8px; border-radius: 10px; margin-left: 8px; font-weight: 500; background: #e8f5e9; color: #2e7d32;">å‡ºç”Ÿæ¸ˆã¿</span>
                            </p>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 14px;">
                                <input type="checkbox" id="child1Enabled" checked onchange="toggleChildSection(1)" style="width: 18px; height: 18px;">
                                <span>è¨ˆç®—ã«å«ã‚ã‚‹</span>
                            </label>
                        </div>
                        <div id="child1Details">
                            <div class="input-row">
                                <div class="input-group">
                                    <div class="input-label">
                                        ç¾åœ¨ã®å¹´é½¢
                                        <span class="help-icon" data-tip="ãƒã‚¤ãƒŠã‚¹ã®å ´åˆã¯å‡ºç”£äºˆå®šï¼ˆä¾‹ï¼š-2 = 2å¹´å¾Œã«å‡ºç”£äºˆå®šï¼‰">?</span>
                                    </div>
                                    <div class="input-wrapper">
                                        <input type="number" id="child1Age" value="5" min="-5" max="30" onchange="updateChildStatus(1)">
                                        <span class="unit-label">æ­³</span>
                                    </div>
                                </div>
                                <div class="input-group"></div>
                            </div>
                            <!-- ç”£ä¼‘ãƒ»è‚²ä¼‘è¨­å®šï¼ˆå¹´é½¢â‰¤0ã®å ´åˆã®ã¿è¡¨ç¤ºï¼‰ -->
                            <div id="child1MaternityDetails" style="display: none;">
                                <div style="background: #fff3e0; padding: 12px; border-radius: 8px; margin-bottom: 10px;">
                                    <p style="font-size: 13px; color: #e65100; margin: 0; font-weight: 600;">
                                        ğŸ¼ ç”£ä¼‘ãƒ»è‚²ä¼‘è¨­å®šï¼ˆå‡ºç”£äºˆå®šï¼š<span id="child1BirthTiming">2å¹´å¾Œ</span>ï¼‰
                                    </p>
                                </div>
                                <input type="hidden" id="child1MaternityStart" value="2">
                                <div class="input-row">
                                    <div class="input-group">
                                        <div class="input-label">è‚²ä¼‘æœŸé–“</div>
                                        <div class="input-wrapper">
                                            <input type="number" id="child1MaternityDuration" value="1" min="0" max="3" step="0.5">
                                            <span class="unit-label">å¹´</span>
                                        </div>
                                    </div>
                                    <div class="input-group">
                                        <div class="input-label">è‚²ä¼‘ä¸­ã®çµ¦ä»˜é‡‘ï¼ˆæœˆé¡ï¼‰</div>
                                        <div class="input-wrapper">
                                            <input type="number" id="child1MaternityAllowance" value="15" step="1">
                                            <span class="unit-label">ä¸‡å††</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="input-row">
                                    <div class="input-group">
                                        <div class="input-label">å¾©å¸°å¾Œã®åå…¥å‰²åˆï¼ˆ3å¹´é–“ï¼‰</div>
                                        <div class="input-wrapper">
                                            <input type="number" id="child1ReturnWorkRate" value="80" min="50" max="100" step="5">
                                            <span class="unit-label">%</span>
                                        </div>
                                    </div>
                                    <div class="input-group"></div>
                                </div>
                            </div>
                            <!-- æ•™è‚²è²»è¨­å®š -->
                            <div class="input-row">
                                <div class="input-group">
                                    <div class="input-label">å¹¼ç¨šåœ’ã€œå°å­¦æ ¡</div>
                                    <div class="input-wrapper">
                                        <select id="child1Elementary">
                                            <option value="10" selected>å…¬ç«‹ï¼ˆå¹´10ä¸‡å††ï¼‰</option>
                                            <option value="90">ç§ç«‹ï¼ˆå¹´90ä¸‡å††ï¼‰</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="input-group">
                                    <div class="input-label">ä¸­å­¦æ ¡</div>
                                    <div class="input-wrapper">
                                        <select id="child1JuniorHigh">
                                            <option value="15" selected>å…¬ç«‹ï¼ˆå¹´15ä¸‡å††ï¼‰</option>
                                            <option value="100">ç§ç«‹ï¼ˆå¹´100ä¸‡å††ï¼‰</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="input-row">
                                <div class="input-group">
                                    <div class="input-label">é«˜æ ¡</div>
                                    <div class="input-wrapper">
                                        <select id="child1HighSchool">
                                            <option value="30" selected>å…¬ç«‹ï¼ˆå¹´30ä¸‡å††ï¼‰</option>
                                            <option value="75">ç§ç«‹ï¼ˆå¹´75ä¸‡å††ï¼‰</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="input-group">
                                    <div class="input-label">å¤§å­¦</div>
                                    <div class="input-wrapper">
                                        <select id="child1University">
                                            <option value="54">å›½å…¬ç«‹ï¼ˆå¹´54ä¸‡å††ï¼‰</option>
                                            <option value="93" selected>ç§ç«‹æ–‡ç³»ï¼ˆå¹´93ä¸‡å††ï¼‰</option>
                                            <option value="124">ç§ç«‹ç†ç³»ï¼ˆå¹´124ä¸‡å††ï¼‰</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- å­ã©ã‚‚2 -->
                    <div id="child2UnifiedSection" class="child-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <p class="child-section-label" style="margin: 0;">
                                å­ã©ã‚‚2
                                <span id="child2StatusBadge" style="font-size: 12px; padding: 2px 8px; border-radius: 10px; margin-left: 8px; font-weight: 500; background: #e8f5e9; color: #2e7d32;">å‡ºç”Ÿæ¸ˆã¿</span>
                            </p>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 14px;">
                                <input type="checkbox" id="child2Enabled" checked onchange="toggleChildSection(2)" style="width: 18px; height: 18px;">
                                <span>è¨ˆç®—ã«å«ã‚ã‚‹</span>
                            </label>
                        </div>
                        <div id="child2Details">
                            <div class="input-row">
                                <div class="input-group">
                                    <div class="input-label">
                                        ç¾åœ¨ã®å¹´é½¢
                                        <span class="help-icon" data-tip="ãƒã‚¤ãƒŠã‚¹ã®å ´åˆã¯å‡ºç”£äºˆå®šï¼ˆä¾‹ï¼š-2 = 2å¹´å¾Œã«å‡ºç”£äºˆå®šï¼‰">?</span>
                                    </div>
                                    <div class="input-wrapper">
                                        <input type="number" id="child2Age" value="3" min="-5" max="30" onchange="updateChildStatus(2)">
                                        <span class="unit-label">æ­³</span>
                                    </div>
                                </div>
                                <div class="input-group"></div>
                            </div>
                            <!-- ç”£ä¼‘ãƒ»è‚²ä¼‘è¨­å®šï¼ˆå¹´é½¢â‰¤0ã®å ´åˆã®ã¿è¡¨ç¤ºï¼‰ -->
                            <div id="child2MaternityDetails" style="display: none;">
                                <div style="background: #fff3e0; padding: 12px; border-radius: 8px; margin-bottom: 10px;">
                                    <p style="font-size: 13px; color: #e65100; margin: 0; font-weight: 600;">
                                        ğŸ¼ ç”£ä¼‘ãƒ»è‚²ä¼‘è¨­å®šï¼ˆå‡ºç”£äºˆå®šï¼š<span id="child2BirthTiming">4å¹´å¾Œ</span>ï¼‰
                                    </p>
                                </div>
                                <input type="hidden" id="child2MaternityStart" value="4">
                                <div class="input-row">
                                    <div class="input-group">
                                        <div class="input-label">è‚²ä¼‘æœŸé–“</div>
                                        <div class="input-wrapper">
                                            <input type="number" id="child2MaternityDuration" value="1" min="0" max="3" step="0.5">
                                            <span class="unit-label">å¹´</span>
                                        </div>
                                    </div>
                                    <div class="input-group">
                                        <div class="input-label">è‚²ä¼‘ä¸­ã®çµ¦ä»˜é‡‘ï¼ˆæœˆé¡ï¼‰</div>
                                        <div class="input-wrapper">
                                            <input type="number" id="child2MaternityAllowance" value="15" step="1">
                                            <span class="unit-label">ä¸‡å††</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="input-row">
                                    <div class="input-group">
                                        <div class="input-label">å¾©å¸°å¾Œã®åå…¥å‰²åˆï¼ˆ3å¹´é–“ï¼‰</div>
                                        <div class="input-wrapper">
                                            <input type="number" id="child2ReturnWorkRate" value="80" min="50" max="100" step="5">
                                            <span class="unit-label">%</span>
                                        </div>
                                    </div>
                                    <div class="input-group"></div>
                                </div>
                            </div>
                            <!-- æ•™è‚²è²»è¨­å®š -->
                            <div class="input-row">
                                <div class="input-group">
                                    <div class="input-label">å¹¼ç¨šåœ’ã€œå°å­¦æ ¡</div>
                                    <div class="input-wrapper">
                                        <select id="child2Elementary">
                                            <option value="10" selected>å…¬ç«‹ï¼ˆå¹´10ä¸‡å††ï¼‰</option>
                                            <option value="90">ç§ç«‹ï¼ˆå¹´90ä¸‡å††ï¼‰</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="input-group">
                                    <div class="input-label">ä¸­å­¦æ ¡</div>
                                    <div class="input-wrapper">
                                        <select id="child2JuniorHigh">
                                            <option value="15" selected>å…¬ç«‹ï¼ˆå¹´15ä¸‡å††ï¼‰</option>
                                            <option value="100">ç§ç«‹ï¼ˆå¹´100ä¸‡å††ï¼‰</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="input-row">
                                <div class="input-group">
                                    <div class="input-label">é«˜æ ¡</div>
                                    <div class="input-wrapper">
                                        <select id="child2HighSchool">
                                            <option value="30" selected>å…¬ç«‹ï¼ˆå¹´30ä¸‡å††ï¼‰</option>
                                            <option value="75">ç§ç«‹ï¼ˆå¹´75ä¸‡å††ï¼‰</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="input-group">
                                    <div class="input-label">å¤§å­¦</div>
                                    <div class="input-wrapper">
                                        <select id="child2University">
                                            <option value="54">å›½å…¬ç«‹ï¼ˆå¹´54ä¸‡å††ï¼‰</option>
                                            <option value="93" selected>ç§ç«‹æ–‡ç³»ï¼ˆå¹´93ä¸‡å††ï¼‰</option>
                                            <option value="124">ç§ç«‹ç†ç³»ï¼ˆå¹´124ä¸‡å††ï¼‰</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- å­ã©ã‚‚3 -->
                    <div id="child3UnifiedSection" class="child-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <p class="child-section-label" style="margin: 0;">
                                å­ã©ã‚‚3
                                <span id="child3StatusBadge" style="font-size: 12px; padding: 2px 8px; border-radius: 10px; margin-left: 8px; font-weight: 500; background: #fce4ec; color: #c62828;">å‡ºç”£äºˆå®š</span>
                            </p>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 14px;">
                                <input type="checkbox" id="child3Enabled" onchange="toggleChildSection(3)" style="width: 18px; height: 18px;">
                                <span>è¨ˆç®—ã«å«ã‚ã‚‹</span>
                            </label>
                        </div>
                        <div id="child3Details" style="display: none;">
                            <div class="input-row">
                                <div class="input-group">
                                    <div class="input-label">
                                        ç¾åœ¨ã®å¹´é½¢
                                        <span class="help-icon" data-tip="ãƒã‚¤ãƒŠã‚¹ã®å ´åˆã¯å‡ºç”£äºˆå®šï¼ˆä¾‹ï¼š-2 = 2å¹´å¾Œã«å‡ºç”£äºˆå®šï¼‰">?</span>
                                    </div>
                                    <div class="input-wrapper">
                                        <input type="number" id="child3Age" value="-2" min="-5" max="30" onchange="updateChildStatus(3)">
                                        <span class="unit-label">æ­³</span>
                                    </div>
                                </div>
                                <div class="input-group"></div>
                            </div>
                            <!-- ç”£ä¼‘ãƒ»è‚²ä¼‘è¨­å®šï¼ˆå¹´é½¢â‰¤0ã®å ´åˆã®ã¿è¡¨ç¤ºï¼‰ -->
                            <div id="child3MaternityDetails" style="display: none;">
                                <div style="background: #fff3e0; padding: 12px; border-radius: 8px; margin-bottom: 10px;">
                                    <p style="font-size: 13px; color: #e65100; margin: 0; font-weight: 600;">
                                        ğŸ¼ ç”£ä¼‘ãƒ»è‚²ä¼‘è¨­å®šï¼ˆå‡ºç”£äºˆå®šï¼š<span id="child3BirthTiming">2å¹´å¾Œ</span>ï¼‰
                                    </p>
                                </div>
                                <input type="hidden" id="child3MaternityStart" value="2">
                                <div class="input-row">
                                    <div class="input-group">
                                        <div class="input-label">è‚²ä¼‘æœŸé–“</div>
                                        <div class="input-wrapper">
                                            <input type="number" id="child3MaternityDuration" value="1" min="0" max="3" step="0.5">
                                            <span class="unit-label">å¹´</span>
                                        </div>
                                    </div>
                                    <div class="input-group">
                                        <div class="input-label">è‚²ä¼‘ä¸­ã®çµ¦ä»˜é‡‘ï¼ˆæœˆé¡ï¼‰</div>
                                        <div class="input-wrapper">
                                            <input type="number" id="child3MaternityAllowance" value="15" step="1">
                                            <span class="unit-label">ä¸‡å††</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="input-row">
                                    <div class="input-group">
                                        <div class="input-label">å¾©å¸°å¾Œã®åå…¥å‰²åˆï¼ˆ3å¹´é–“ï¼‰</div>
                                        <div class="input-wrapper">
                                            <input type="number" id="child3ReturnWorkRate" value="80" min="50" max="100" step="5">
                                            <span class="unit-label">%</span>
                                        </div>
                                    </div>
                                    <div class="input-group"></div>
                                </div>
                            </div>
                            <!-- æ•™è‚²è²»è¨­å®š -->
                            <div class="input-row">
                                <div class="input-group">
                                    <div class="input-label">å¹¼ç¨šåœ’ã€œå°å­¦æ ¡</div>
                                    <div class="input-wrapper">
                                        <select id="child3Elementary">
                                            <option value="10" selected>å…¬ç«‹ï¼ˆå¹´10ä¸‡å††ï¼‰</option>
                                            <option value="90">ç§ç«‹ï¼ˆå¹´90ä¸‡å††ï¼‰</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="input-group">
                                    <div class="input-label">ä¸­å­¦æ ¡</div>
                                    <div class="input-wrapper">
                                        <select id="child3JuniorHigh">
                                            <option value="15" selected>å…¬ç«‹ï¼ˆå¹´15ä¸‡å††ï¼‰</option>
                                            <option value="100">ç§ç«‹ï¼ˆå¹´100ä¸‡å††ï¼‰</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="input-row">
                                <div class="input-group">
                                    <div class="input-label">é«˜æ ¡</div>
                                    <div class="input-wrapper">
                                        <select id="child3HighSchool">
                                            <option value="30" selected>å…¬ç«‹ï¼ˆå¹´30ä¸‡å††ï¼‰</option>
                                            <option value="75">ç§ç«‹ï¼ˆå¹´75ä¸‡å††ï¼‰</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="input-group">
                                    <div class="input-label">å¤§å­¦</div>
                                    <div class="input-wrapper">
                                        <select id="child3University">
                                            <option value="54">å›½å…¬ç«‹ï¼ˆå¹´54ä¸‡å††ï¼‰</option>
                                            <option value="93" selected>ç§ç«‹æ–‡ç³»ï¼ˆå¹´93ä¸‡å††ï¼‰</option>
                                            <option value="124">ç§ç«‹ç†ç³»ï¼ˆå¹´124ä¸‡å††ï¼‰</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- å‚è€ƒæƒ…å ± -->
                    <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-top: 15px;">
                        <p style="font-size: 14px; color: #333; margin: 0 0 10px 0; font-weight: 600;">
                            ğŸ’¡ è‚²å…ä¼‘æ¥­çµ¦ä»˜é‡‘ã®å‚è€ƒ
                        </p>
                        <ul style="font-size: 13px; color: #666; margin: 0; padding-left: 20px; line-height: 1.8;">
                            <li>è‚²ä¼‘é–‹å§‹ã€œ6ãƒ¶æœˆï¼šè³ƒé‡‘ã®67%ï¼ˆæœˆé¡ä¸Šé™30.6ä¸‡å††ï¼‰</li>
                            <li>è‚²ä¼‘6ãƒ¶æœˆä»¥é™ï¼šè³ƒé‡‘ã®50%ï¼ˆæœˆé¡ä¸Šé™23.0ä¸‡å††ï¼‰</li>
                            <li>å¾©å¸°å¾Œï¼šæ™‚çŸ­å‹¤å‹™ç­‰ã§åå…¥æ¸›ï¼ˆ80-90%ç¨‹åº¦ãŒä¸€èˆ¬çš„ï¼‰</li>
                            <li>ğŸ“ ä¾‹ï¼šæœˆå25ä¸‡å†† â†’ è‚²ä¼‘ä¸­15-17ä¸‡å††ç¨‹åº¦</li>
                        </ul>
                        <p style="font-size: 14px; color: #333; margin: 12px 0 10px 0; font-weight: 600;">
                            ğŸ“š æ•™è‚²è²»ã®å‚è€ƒï¼ˆæ–‡éƒ¨ç§‘å­¦çœãƒ‡ãƒ¼ã‚¿ï¼‰
                        </p>
                        <ul style="font-size: 13px; color: #666; margin: 0; padding-left: 20px; line-height: 1.8;">
                            <li><strong>å¹¼ç¨šåœ’:</strong> å…¬ç«‹23ä¸‡å††ã€ç§ç«‹48ä¸‡å††</li>
                            <li><strong>å°å­¦æ ¡:</strong> å…¬ç«‹35ä¸‡å††ã€ç§ç«‹166ä¸‡å††</li>
                            <li><strong>ä¸­å­¦æ ¡:</strong> å…¬ç«‹54ä¸‡å††ã€ç§ç«‹144ä¸‡å††</li>
                            <li><strong>é«˜æ ¡:</strong> å…¬ç«‹51ä¸‡å††ã€ç§ç«‹105ä¸‡å††</li>
                            <li><strong>å¤§å­¦:</strong> å›½å…¬ç«‹54ä¸‡å††ã€ç§ç«‹æ–‡ç³»93ä¸‡å††ã€ç§ç«‹ç†ç³»124ä¸‡å††</li>
                        </ul>
                        <p style="font-size: 14px; color: #333; margin: 12px 0 10px 0; font-weight: 600;">
                            ğŸ’° å…ç«¥æ‰‹å½“ï¼ˆ2024å¹´10æœˆæ”¹æ­£ï¼‰
                        </p>
                        <ul style="font-size: 13px; color: #666; margin: 0; padding-left: 20px; line-height: 1.8;">
                            <li>0ã€œ2æ­³ï¼šæœˆ1.5ä¸‡å††ã€3æ­³ã€œé«˜æ ¡å’æ¥­ï¼šæœˆ1ä¸‡å††ï¼ˆç¬¬3å­ä»¥é™ã¯æœˆ3ä¸‡å††ï¼‰</li>
                            <li><strong>æ‰€å¾—åˆ¶é™æ’¤å»ƒ</strong>ï¼ˆå…¨ä¸–å¸¯å¯¾è±¡ï¼‰</li>
                        </ul>
                    </div>
                    </div><!-- accordion-body-inner -->
                    </div><!-- accordion-body -->
                </div>

                <!-- è¦ªã®ä»‹è­· -->
                <div class="advanced-section">
                    <div class="accordion-header" onclick="toggleAccordion(this)">
                        <div class="advanced-section-title">ğŸ‘´ è¦ªã®ä»‹è­·è²»ç”¨</div>
                        <span class="accordion-chevron">â–¾</span>
                    </div>
                    <div class="accordion-body">
                    <div class="accordion-body-inner">
                    <div class="comparison-toggle">
                        <label class="switch">
                            <input type="checkbox" id="hasCare" onchange="toggleCareSettings()">
                            <span class="slider-switch"></span>
                        </label>
                        <span style="font-weight: 600;">è¦ªã®ä»‹è­·è²»ç”¨ã‚’è¦‹è¾¼ã‚€</span>
                    </div>
                    <div id="careSettings" style="display: none; margin-top: 15px;">
                        <div class="input-row">
                            <div class="input-group">
                                <div class="input-label">
                                    ä»‹è­·é–‹å§‹æ™‚æœŸ
                                    <span class="help-icon" data-tip="æœ¬äººã®å¹´é½¢ãŒä½•æ­³ã®æ™‚ã«é–‹å§‹ã™ã‚‹ã‹">?</span>
                                </div>
                                <div class="input-wrapper">
                                    <input type="number" id="careStartAge" value="50" min="30" max="70">
                                    <span class="unit-label">æ­³</span>
                                </div>
                            </div>
                            <div class="input-group">
                                <div class="input-label">
                                    ä»‹è­·æœŸé–“
                                    <span class="help-icon" data-tip="ä»‹è­·ãŒå¿…è¦ãªå¹´æ•°">?</span>
                                </div>
                                <div class="input-wrapper">
                                    <input type="number" id="careDuration" value="5" min="1" max="20">
                                    <span class="unit-label">å¹´</span>
                                </div>
                            </div>
                        </div>
                        <div class="input-row">
                            <div class="input-group">
                                <div class="input-label">
                                    æœˆé¡ä»‹è­·è²»ç”¨
                                    <span class="help-icon" data-tip="æ–½è¨­è²»ç”¨ãƒ»åœ¨å®…ã‚µãƒ¼ãƒ“ã‚¹ç­‰">?</span>
                                </div>
                                <div class="input-wrapper">
                                    <input type="number" id="careCost" value="8" step="1">
                                    <span class="unit-label">ä¸‡å††</span>
                                </div>
                            </div>
                            <div class="input-group">
                                <div class="input-label">
                                    ä»‹è­·ä¿é™ºã®è‡ªå·±è² æ‹…å‰²åˆ
                                    <span class="help-icon" data-tip="é€šå¸¸1å‰²ã€æ‰€å¾—ã«ã‚ˆã‚Š2-3å‰²">?</span>
                                </div>
                                <div class="input-wrapper">
                                    <select id="careInsuranceRate">
                                        <option value="0.1" selected>1å‰²è² æ‹…</option>
                                        <option value="0.2">2å‰²è² æ‹…</option>
                                        <option value="0.3">3å‰²è² æ‹…</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div style="background: #fff3e0; padding: 12px; border-radius: 8px; margin-top: 15px;">
                            <p style="font-size: 13px; color: #666; margin: 0; line-height: 1.5;">
                                ğŸ’¡ <strong>å‚è€ƒï¼š</strong>åœ¨å®…ä»‹è­·ã§æœˆ5ã€œ10ä¸‡å††ã€æ–½è¨­å…¥å±…ã§æœˆ10ã€œ20ä¸‡å††ç¨‹åº¦ã€‚å¹³å‡ä»‹è­·æœŸé–“ã¯ç´„5å¹´ã€‚
                            </p>
                        </div>
                    </div>
                    </div><!-- accordion-body-inner -->
                    </div><!-- accordion-body -->
                </div>

                <!-- ä¿é™º -->
                <div class="advanced-section">
                    <div class="accordion-header" onclick="toggleAccordion(this)">
                        <div class="advanced-section-title">ğŸ›¡ï¸ ä¿é™ºã®è¨­å®š</div>
                        <span class="accordion-chevron">â–¾</span>
                    </div>
                    <div class="accordion-body">
                    <div class="accordion-body-inner">
                    <div class="input-row">
                        <div class="input-group">
                            <div class="input-label">ç”Ÿå‘½ä¿é™ºï¼ˆæœˆé¡ï¼‰</div>
                            <div class="input-wrapper">
                                <input type="number" id="lifeInsurance" value="5" step="0.5">
                                <span class="unit-label">ä¸‡å††</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <div class="input-label">æå®³ä¿é™ºï¼ˆæœˆé¡ï¼‰</div>
                            <div class="input-wrapper">
                                <input type="number" id="propertyInsurance" value="3" step="0.5">
                                <span class="unit-label">ä¸‡å††</span>
                            </div>
                        </div>
                    </div>
                    </div><!-- accordion-body-inner -->
                    </div><!-- accordion-body -->
                </div>

                <!-- è‡¨æ™‚æ”¯å‡º -->
                <div class="advanced-section">
                    <div class="accordion-header" onclick="toggleAccordion(this)">
                        <div class="advanced-section-title">ğŸ’¸ è‡¨æ™‚æ”¯å‡ºã®è¨­å®š</div>
                        <span class="accordion-chevron">â–¾</span>
                    </div>
                    <div class="accordion-body">
                    <div class="accordion-body-inner">
                    <p style="font-size: 13px; color: #666; margin: 0 0 15px 0;">
                        ğŸ’¡ è»Šã®è²·ã„æ›¿ãˆã€ãƒªãƒ•ã‚©ãƒ¼ãƒ ã€å®¶é›»ã®è²·ã„æ›¿ãˆãªã©ã€å®šæœŸçš„ãƒ»ä¸å®šæœŸçš„ãªå¤§ããªå‡ºè²»ã‚’è¨­å®šã§ãã¾ã™
                    </p>
                    
                    <!-- è‡¨æ™‚æ”¯å‡º1 -->
                    <div class="temp-expense-section">
                        <p class="temp-expense-label">è‡¨æ™‚æ”¯å‡º1</p>
                        <div class="input-row">
                            <div class="input-group">
                                <div class="input-label">æ”¯å‡ºå</div>
                                <div class="input-wrapper">
                                    <input type="text" id="temp1Name" value="è»Šã®è²·ã„æ›¿ãˆ" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                </div>
                            </div>
                            <div class="input-group">
                                <div class="input-label">é‡‘é¡</div>
                                <div class="input-wrapper">
                                    <input type="number" id="temp1Amount" value="300" step="10">
                                    <span class="unit-label">ä¸‡å††</span>
                                </div>
                            </div>
                        </div>
                        <div class="input-row">
                            <div class="input-group">
                                <div class="input-label">ç™ºç”Ÿæ™‚æœŸ</div>
                                <div class="input-wrapper">
                                    <input type="number" id="temp1Year" value="10" min="0" max="60">
                                    <span class="unit-label">å¹´å¾Œ</span>
                                </div>
                            </div>
                            <div class="input-group">
                                <div class="input-label">ç¹°ã‚Šè¿”ã—</div>
                                <div class="input-wrapper">
                                    <select id="temp1Repeat">
                                        <option value="0">ãªã—</option>
                                        <option value="5">5å¹´ã”ã¨</option>
                                        <option value="7" selected>7å¹´ã”ã¨</option>
                                        <option value="10">10å¹´ã”ã¨</option>
                                        <option value="15">15å¹´ã”ã¨</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- è‡¨æ™‚æ”¯å‡º2 -->
                    <div class="temp-expense-section">
                        <p class="temp-expense-label">è‡¨æ™‚æ”¯å‡º2</p>
                        <div class="input-row">
                            <div class="input-group">
                                <div class="input-label">æ”¯å‡ºå</div>
                                <div class="input-wrapper">
                                    <input type="text" id="temp2Name" value="ãƒªãƒ•ã‚©ãƒ¼ãƒ " style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                </div>
                            </div>
                            <div class="input-group">
                                <div class="input-label">é‡‘é¡</div>
                                <div class="input-wrapper">
                                    <input type="number" id="temp2Amount" value="200" step="10">
                                    <span class="unit-label">ä¸‡å††</span>
                                </div>
                            </div>
                        </div>
                        <div class="input-row">
                            <div class="input-group">
                                <div class="input-label">ç™ºç”Ÿæ™‚æœŸ</div>
                                <div class="input-wrapper">
                                    <input type="number" id="temp2Year" value="20" min="0" max="60">
                                    <span class="unit-label">å¹´å¾Œ</span>
                                </div>
                            </div>
                            <div class="input-group">
                                <div class="input-label">ç¹°ã‚Šè¿”ã—</div>
                                <div class="input-wrapper">
                                    <select id="temp2Repeat">
                                        <option value="0" selected>ãªã—</option>
                                        <option value="5">5å¹´ã”ã¨</option>
                                        <option value="7">7å¹´ã”ã¨</option>
                                        <option value="10">10å¹´ã”ã¨</option>
                                        <option value="15">15å¹´ã”ã¨</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- è‡¨æ™‚æ”¯å‡º3 -->
                    <div class="temp-expense-section">
                        <p class="temp-expense-label">è‡¨æ™‚æ”¯å‡º3</p>
                        <div class="input-row">
                            <div class="input-group">
                                <div class="input-label">æ”¯å‡ºå</div>
                                <div class="input-wrapper">
                                    <input type="text" id="temp3Name" value="" placeholder="ä¾‹ï¼šå®¶é›»è²·ã„æ›¿ãˆ" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                </div>
                            </div>
                            <div class="input-group">
                                <div class="input-label">é‡‘é¡</div>
                                <div class="input-wrapper">
                                    <input type="number" id="temp3Amount" value="0" step="10">
                                    <span class="unit-label">ä¸‡å††</span>
                                </div>
                            </div>
                        </div>
                        <div class="input-row">
                            <div class="input-group">
                                <div class="input-label">ç™ºç”Ÿæ™‚æœŸ</div>
                                <div class="input-wrapper">
                                    <input type="number" id="temp3Year" value="0" min="0" max="60">
                                    <span class="unit-label">å¹´å¾Œ</span>
                                </div>
                            </div>
                            <div class="input-group">
                                <div class="input-label">ç¹°ã‚Šè¿”ã—</div>
                                <div class="input-wrapper">
                                    <select id="temp3Repeat">
                                        <option value="0" selected>ãªã—</option>
                                        <option value="5">5å¹´ã”ã¨</option>
                                        <option value="7">7å¹´ã”ã¨</option>
                                        <option value="10">10å¹´ã”ã¨</option>
                                        <option value="15">15å¹´ã”ã¨</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- è‡¨æ™‚æ”¯å‡º4 -->
                    <div class="temp-expense-section">
                        <p class="temp-expense-label">è‡¨æ™‚æ”¯å‡º4</p>
                        <div class="input-row">
                            <div class="input-group">
                                <div class="input-label">æ”¯å‡ºå</div>
                                <div class="input-wrapper">
                                    <input type="text" id="temp4Name" value="" placeholder="ä¾‹ï¼šæ—…è¡Œãƒ»ãƒ¬ã‚¸ãƒ£ãƒ¼" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                </div>
                            </div>
                            <div class="input-group">
                                <div class="input-label">é‡‘é¡</div>
                                <div class="input-wrapper">
                                    <input type="number" id="temp4Amount" value="0" step="10">
                                    <span class="unit-label">ä¸‡å††</span>
                                </div>
                            </div>
                        </div>
                        <div class="input-row">
                            <div class="input-group">
                                <div class="input-label">ç™ºç”Ÿæ™‚æœŸ</div>
                                <div class="input-wrapper">
                                    <input type="number" id="temp4Year" value="0" min="0" max="60">
                                    <span class="unit-label">å¹´å¾Œ</span>
                                </div>
                            </div>
                            <div class="input-group">
                                <div class="input-label">ç¹°ã‚Šè¿”ã—</div>
                                <div class="input-wrapper">
                                    <select id="temp4Repeat">
                                        <option value="0" selected>ãªã—</option>
                                        <option value="5">5å¹´ã”ã¨</option>
                                        <option value="7">7å¹´ã”ã¨</option>
                                        <option value="10">10å¹´ã”ã¨</option>
                                        <option value="15">15å¹´ã”ã¨</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- è‡¨æ™‚æ”¯å‡º5 -->
                    <div class="temp-expense-section">
                        <p class="temp-expense-label">è‡¨æ™‚æ”¯å‡º5</p>
                        <div class="input-row">
                            <div class="input-group">
                                <div class="input-label">æ”¯å‡ºå</div>
                                <div class="input-wrapper">
                                    <input type="text" id="temp5Name" value="" placeholder="ä¾‹ï¼šçµå©šå¼è²»ç”¨" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                </div>
                            </div>
                            <div class="input-group">
                                <div class="input-label">é‡‘é¡</div>
                                <div class="input-wrapper">
                                    <input type="number" id="temp5Amount" value="0" step="10">
                                    <span class="unit-label">ä¸‡å††</span>
                                </div>
                            </div>
                        </div>
                        <div class="input-row">
                            <div class="input-group">
                                <div class="input-label">ç™ºç”Ÿæ™‚æœŸ</div>
                                <div class="input-wrapper">
                                    <input type="number" id="temp5Year" value="0" min="0" max="60">
                                    <span class="unit-label">å¹´å¾Œ</span>
                                </div>
                            </div>
                            <div class="input-group">
                                <div class="input-label">ç¹°ã‚Šè¿”ã—</div>
                                <div class="input-wrapper">
                                    <select id="temp5Repeat">
                                        <option value="0" selected>ãªã—</option>
                                        <option value="5">5å¹´ã”ã¨</option>
                                        <option value="7">7å¹´ã”ã¨</option>
                                        <option value="10">10å¹´ã”ã¨</option>
                                        <option value="15">15å¹´ã”ã¨</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    </div><!-- accordion-body-inner -->
                    </div><!-- accordion-body -->
                </div>

                <!-- è³‡ç”£é‹ç”¨ -->
                <div class="advanced-section">
                    <div class="accordion-header" onclick="toggleAccordion(this)">
                        <div class="advanced-section-title">ğŸ“ˆ è³‡ç”£é‹ç”¨ã®è¨­å®š</div>
                        <span class="accordion-chevron">â–¾</span>
                    </div>
                    <div class="accordion-body">
                    <div class="accordion-body-inner">
                    
                    <!-- è²¯è“„ï¼ˆæ™®é€šé é‡‘ï¼‰ -->
                    <div style="background: #f0f0f0; padding: 12px; border-radius: 8px; margin-bottom: 15px;">
                        <p style="font-size: 14px; font-weight: 600; margin: 0 0 10px 0;">ğŸ’° è²¯è“„ï¼ˆæ™®é€šé é‡‘ãƒ»åˆ©å›ã‚Š0%ï¼‰</p>
                        <div class="input-row">
                            <div class="input-group">
                                <div class="input-label">
                                    åˆæœŸè²¯è“„
                                    <span class="help-icon" data-tip="ç¾åœ¨ä¿æœ‰ã—ã¦ã„ã‚‹è²¯è“„é¡">?</span>
                                </div>
                                <div class="input-wrapper">
                                    <input type="number" id="savingsStart" value="500" step="50">
                                    <span class="unit-label">ä¸‡å††</span>
                                </div>
                            </div>
                            <div class="input-group"></div>
                        </div>
                        <p style="font-size: 12px; color: #666; margin: 8px 0 0 0;">
                            â„¹ï¸ è²¯è“„æ®‹é«˜ã«ã¯é‹ç”¨åˆ©å›ã‚Šã¯ã‹ã‹ã‚Šã¾ã›ã‚“ï¼ˆç”Ÿæ´»é˜²è¡›è³‡é‡‘ã¨ã—ã¦æ™®é€šé é‡‘ã§ç®¡ç†ï¼‰
                        </p>
                    </div>

                    <!-- ä¸€æ‹¬æŠ•è³‡ -->
                    <div style="background: #e3f2fd; padding: 12px; border-radius: 8px; margin-bottom: 15px;">
                        <p style="font-size: 14px; font-weight: 600; margin: 0 0 10px 0;">ğŸ’µ ä¸€æ‹¬æŠ•è³‡</p>
                        <div class="input-row">
                            <div class="input-group">
                                <div class="input-label">
                                    ä¸€æ‹¬æŠ•è³‡é¡ï¼ˆåˆæœŸï¼‰
                                    <span class="help-icon" data-tip="é–‹å§‹æ™‚ã«ä¸€æ‹¬ã§æŠ•è³‡ã™ã‚‹é‡‘é¡">?</span>
                                </div>
                                <div class="input-wrapper">
                                    <input type="number" id="lumpSumInvestment" value="0" step="50">
                                    <span class="unit-label">ä¸‡å††</span>
                                </div>
                            </div>
                            <div class="input-group">
                                <div class="input-label">
                                    é‹ç”¨åˆ©å›ã‚Šï¼ˆå¹´é–“ï¼‰
                                    <span class="help-icon" data-tip="ä¸€æ‹¬æŠ•è³‡ã®æœŸå¾…ãƒªã‚¿ãƒ¼ãƒ³">?</span>
                                </div>
                                <div class="input-wrapper">
                                    <input type="number" id="lumpSumReturn" value="3.0" step="0.5" min="0" max="15">
                                    <span class="unit-label">%</span>
                                </div>
                            </div>
                        </div>
                        <div class="input-row">
                            <div class="input-group">
                                <div class="input-label">
                                    é‹ç”¨æœŸé–“
                                    <span class="help-icon" data-tip="ä¸€æ‹¬æŠ•è³‡ã®é‹ç”¨æœŸé–“ï¼ˆæœŸé–“çµ‚äº†å¾Œã¯åˆ©å›ã‚Š0%ï¼‰">?</span>
                                </div>
                                <div class="input-wrapper">
                                    <input type="number" id="lumpSumYears" value="30" min="0" max="60">
                                    <span class="unit-label">å¹´</span>
                                </div>
                            </div>
                            <div class="input-group"></div>
                        </div>
                        <p style="font-size: 12px; color: #666; margin: 8px 0 0 0;">
                            â„¹ï¸ é‹ç”¨æœŸé–“çµ‚äº†å¾Œã¯åˆ©å›ã‚Š0%ã§ä¿æŒã•ã‚Œã¾ã™
                        </p>
                    </div>

                    <!-- ç©ç«‹æŠ•è³‡ -->
                    <div style="background: #e8f5e9; padding: 12px; border-radius: 8px; margin-bottom: 15px;">
                        <p style="font-size: 14px; font-weight: 600; margin: 0 0 10px 0;">ğŸ“Š ç©ç«‹æŠ•è³‡ï¼ˆNISAãƒ»iDeCoãªã©ï¼‰</p>
                        <div class="input-row">
                            <div class="input-group">
                                <div class="input-label">
                                    æ¯æœˆã®ç©ç«‹é¡
                                    <span class="help-icon" data-tip="æ¯æœˆå®šé¡ã§ç©ç«‹æŠ•è³‡ã™ã‚‹é‡‘é¡">?</span>
                                </div>
                                <div class="input-wrapper">
                                    <input type="number" id="monthlyInvestment" value="3" step="0.5">
                                    <span class="unit-label">ä¸‡å††</span>
                                </div>
                            </div>
                            <div class="input-group">
                                <div class="input-label">
                                    é‹ç”¨åˆ©å›ã‚Šï¼ˆå¹´é–“ï¼‰
                                    <span class="help-icon" data-tip="ç©ç«‹æŠ•è³‡ã®æœŸå¾…ãƒªã‚¿ãƒ¼ãƒ³">?</span>
                                </div>
                                <div class="input-wrapper">
                                    <input type="number" id="monthlyReturn" value="3.0" step="0.5" min="0" max="15">
                                    <span class="unit-label">%</span>
                                </div>
                            </div>
                        </div>
                        <div class="input-row">
                            <div class="input-group">
                                <div class="input-label">
                                    ç©ç«‹æœŸé–“
                                    <span class="help-icon" data-tip="ä½•å¹´é–“ç©ç«‹ã‚’ç¶šã‘ã‚‹ã‹">?</span>
                                </div>
                                <div class="input-wrapper">
                                    <input type="number" id="investmentYears" value="30" min="0" max="60">
                                    <span class="unit-label">å¹´</span>
                                </div>
                            </div>
                            <div class="input-group"></div>
                        </div>
                        <p style="font-size: 12px; color: #666; margin: 8px 0 0 0;">
                            â„¹ï¸ ç©ç«‹æœŸé–“ä¸­ã¯åˆ©å›ã‚ŠãŒé©ç”¨ã•ã‚Œã¾ã™ã€‚ç©ç«‹æœŸé–“çµ‚äº†å¾Œã¯åˆ©å›ã‚Š0%ã®è²¯è“„ã¨ã—ã¦ä¿æŒã•ã‚Œã¾ã™ã€‚
                        </p>
                    </div>
                    
                    <div style="background: #fff3e0; padding: 15px; border-radius: 8px;">
                        <p style="font-size: 14px; color: #333; margin: 0 0 10px 0; font-weight: 600;">
                            ğŸ’¡ é‹ç”¨åˆ©å›ã‚Šã®å‚è€ƒ
                        </p>
                        <ul style="font-size: 13px; color: #666; margin: 0; padding-left: 20px; line-height: 1.8;">
                            <li><strong>ä¿å®ˆçš„:</strong> 1-2%ï¼ˆå‚µåˆ¸ä¸­å¿ƒã€å…ƒæœ¬é‡è¦–ï¼‰</li>
                            <li><strong>ãƒãƒ©ãƒ³ã‚¹å‹:</strong> 3-4%ï¼ˆæ ªå¼50%ãƒ»å‚µåˆ¸50%ï¼‰</li>
                            <li><strong>ç©æ¥µçš„:</strong> 5-7%ï¼ˆæ ªå¼ä¸­å¿ƒã€é•·æœŸé‹ç”¨å‰æï¼‰</li>
                            <li style="margin-top: 8px; color: #1a3a5c;">âš ï¸ éå»ã®å®Ÿç¸¾ã§ã‚ã‚Šã€å°†æ¥ã‚’ä¿è¨¼ã™ã‚‹ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“</li>
                        </ul>
                    </div>
                    </div><!-- accordion-body-inner -->
                    </div><!-- accordion-body -->
                </div>

            </div>

            <!-- çµæœè¡¨ç¤º -->
            <div class="results" id="results">
                <!-- ã‚¢ãƒ©ãƒ¼ãƒˆ -->
                <div id="alertBox"></div>

                <!-- ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ -->
                <div class="summary-cards" id="summaryCards"></div>

                <!-- è¿”æ¸ˆè² æ‹…ç‡ã®èª¬æ˜ -->
                <div style="background: #fff3e0; padding: 15px; border-radius: 12px; margin: 20px 0; border-left: 4px solid #ff9800;">
                    <p style="font-size: 14px; color: #333; margin: 0 0 10px 0; font-weight: 600;">
                        ğŸ“Š è¿”æ¸ˆè² æ‹…ç‡ã«ã¤ã„ã¦
                    </p>
                    <p style="font-size: 13px; color: #666; margin: 0; line-height: 1.8;">
                        <strong>è¿”æ¸ˆè² æ‹…ç‡</strong>ã¯ã€ä½å®…è³¼å…¥æ™‚ã®ä¸–å¸¯å¹´åã«å¯¾ã™ã‚‹å¹´é–“æ”¯å‡ºï¼ˆä½å±…è²»ã‚’å«ã‚€ï¼‰ã®å‰²åˆã§ã™ã€‚<br>
                        ä¸€èˆ¬çš„ã«<strong>35%ä»¥ä¸‹ãŒé©æ­£</strong>ã€40%ã‚’è¶…ãˆã‚‹ã¨å®¶è¨ˆãŒåœ§è¿«ã•ã‚Œã‚‹ãƒªã‚¹ã‚¯ãŒé«˜ã¾ã‚Šã¾ã™ã€‚
                    </p>
                </div>

                <!-- æ¯”è¼ƒçµæœï¼ˆæ¯”è¼ƒãƒ¢ãƒ¼ãƒ‰æ™‚ã®ã¿è¡¨ç¤ºï¼‰ -->
                <div id="comparisonResults" style="display: none;"></div>

                <!-- ã‚¿ãƒ– -->
                <div class="tabs">
                    <button class="tab active" onclick="switchTab(event, 'overview')">ğŸ“Š æ¦‚è¦</button>
                    <button class="tab" onclick="switchTab(event, 'graphs')">ğŸ“ˆ è©³ç´°ã‚°ãƒ©ãƒ•</button>
                    <button class="tab" id="comparisonTab" onclick="switchTab(event, 'comparison')" style="display: none;">ğŸ”„ é‡‘åˆ©æ¯”è¼ƒ</button>
                    <button class="tab" onclick="switchTab(event, 'table')">ğŸ“‹ ãƒ‡ãƒ¼ã‚¿è¡¨</button>
                </div>

                <!-- æ¦‚è¦ã‚¿ãƒ– -->
                <div id="overview" class="tab-content active">
                    <div class="chart-container">
                        <div class="chart-title">å¹´é–“åæ”¯ã¨è²¯è“„æ®‹é«˜ã®æ¨ç§»</div>
                        <div class="chart-wrapper">
                            <canvas id="overviewChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- ã‚°ãƒ©ãƒ•ã‚¿ãƒ– -->
                <div id="graphs" class="tab-content">
                    <div class="chart-container">
                        <div class="chart-title">åå…¥ã®æ¨ç§»</div>
                        <div class="chart-wrapper">
                            <canvas id="incomeChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-container">
                        <div class="chart-title">æ”¯å‡ºã®å†…è¨³æ¨ç§»</div>
                        <div class="chart-wrapper">
                            <canvas id="expenseChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-container">
                        <div class="chart-title">è²¯è“„æ®‹é«˜ã®æ¨ç§»</div>
                        <div class="chart-wrapper">
                            <canvas id="savingsChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-container">
                        <div class="chart-title">ä½å®…ãƒ­ãƒ¼ãƒ³è¿”æ¸ˆã®å†…è¨³</div>
                        <div class="chart-wrapper">
                            <canvas id="loanChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- ãƒ‡ãƒ¼ã‚¿è¡¨ã‚¿ãƒ– -->
                <div id="table" class="tab-content">
                    <div class="chart-container">
                        <div class="chart-title">å¹´é–“ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼è¡¨ï¼ˆ60å¹´é–“ï¼‰</div>
                        <button class="download-btn" onclick="downloadCSV()">ğŸ“¥ CSVå½¢å¼ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                        <div class="table-container">
                            <table id="cashflowTable"></table>
                        </div>
                    </div>
                </div>

                <!-- æ¯”è¼ƒã‚¿ãƒ– -->
                <div id="comparison" class="tab-content">
                    <div id="comparisonContent"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- å…±æœ‰ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="shareModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">ğŸ”— è¨­å®šã‚’å…±æœ‰</div>
                <span class="modal-close" onclick="closeShareModal()">&times;</span>
            </div>
            <div class="share-url-container">
                <div class="share-url-label">ä»¥ä¸‹ã®URLã§ç¾åœ¨ã®è¨­å®šã‚’å…±æœ‰ã§ãã¾ã™</div>
                <input type="text" class="share-url" id="shareURL" readonly onclick="this.select()">
            </div>
            <button class="copy-btn" onclick="copyShareURL()">ğŸ“‹ URLã‚’ã‚³ãƒ”ãƒ¼</button>
            <div class="copy-success" id="copySuccess">âœ… ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼</div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script>
        let charts = {};
        let cashflowData = [];

        // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼æ›´æ–°
        function updateSlider(id) {
            const slider = document.getElementById(id);
            const display = document.getElementById(id + 'Value');
            let value = slider.value;
            let unit = '';

            switch(id) {
                case 'person1Age':
                case 'person2Age':
                    unit = value == 0 ? 'ãªã—' : value + 'æ­³';
                    break;
                case 'totalIncome':
                case 'propertyPrice':
                case 'downPayment':
                    unit = value + 'ä¸‡å††';
                    break;
                case 'numChildren':
                    unit = value + 'äºº';
                    break;
            }

            display.textContent = unit;

            // ä¸–å¸¯å¹´åã‚’åˆ†å‰²ã—ã¦å€‹åˆ¥ã®åå…¥ã«åæ˜ 
            if (id === 'totalIncome') {
                const total = parseInt(value);
                const person2AgeVal = parseInt(document.getElementById('person2Age').value);
                if (person2AgeVal > 0) {
                    // é…å¶è€…ãŒã„ã‚‹å ´åˆï¼š6:4ã§åˆ†å‰²
                    document.getElementById('person1Income').value = Math.round(total * 0.6);
                    document.getElementById('person2Income').value = Math.round(total * 0.4);
                } else {
                    // å˜èº«ã®å ´åˆï¼šã™ã¹ã¦æœ¬äºº
                    document.getElementById('person1Income').value = total;
                    document.getElementById('person2Income').value = 0;
                }
            }

            // å­ã©ã‚‚ã®å¹´é½¢ã‚’è‡ªå‹•è¨­å®š
            if (id === 'numChildren') {
                const num = parseInt(value);
                document.getElementById('child1Age').value = num >= 1 ? 5 : 0;
                document.getElementById('child2Age').value = num >= 2 ? 3 : 0;
                document.getElementById('child3Age').value = num >= 3 ? -2 : 0;

                // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã¨è¡¨ç¤ºã‚’é€£å‹•
                document.getElementById('child1Enabled').checked = num >= 1;
                document.getElementById('child2Enabled').checked = num >= 2;
                document.getElementById('child3Enabled').checked = num >= 3;

                for (let i = 1; i <= 3; i++) {
                    toggleChildSection(i);
                }
            }
        }

        // åå…¥è©³ç´° â†’ ä¸–å¸¯å¹´åã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã«é€£å‹•
        function syncTotalIncome() {
            const p1 = parseFloat(document.getElementById('person1Income').value) || 0;
            const p2 = parseFloat(document.getElementById('person2Income').value) || 0;
            const total = p1 + p2;
            const slider = document.getElementById('totalIncome');
            const clamped = Math.min(Math.max(total, parseInt(slider.min)), parseInt(slider.max));
            slider.value = clamped;
            document.getElementById('totalIncomeValue').textContent = clamped + 'ä¸‡å††';
        }

        // é…å¶è€…å¹´å â†’ å°±åŠ´ãƒ‘ã‚¿ãƒ¼ãƒ³1ã®å¹´åã‚’åŒæœŸ
        function syncWorkPatternIncome() {
            const p2Income = parseFloat(document.getElementById('person2Income').value) || 0;
            const firstPattern = document.querySelector('.person2-work-pattern');
            if (firstPattern) {
                const incomeInput = firstPattern.querySelector('.workPatternIncome');
                if (incomeInput) incomeInput.value = p2Income;
            }
        }

        // ç‰©ä»¶ä¾¡æ ¼ã®è‡ªå‹•è¨ˆç®—
        function updateTotalPrice() {
            const land = parseFloat(document.getElementById('landPrice').value) || 0;
            const building = parseFloat(document.getElementById('buildingPrice').value) || 0;
            const additional = parseFloat(document.getElementById('additionalCost').value) || 0;
            const total = land + building + additional;
            
            document.getElementById('totalPriceCalc').value = total;
            document.getElementById('propertyPrice').value = total;
            updateSlider('propertyPrice');
        }

        // é•·æœŸå„ªè‰¯ä½å®…ã®è¨­å®šè¡¨ç¤ºåˆ‡æ›¿
        function updateLongTermBenefits() {
            const isLongTerm = document.getElementById('isLongTerm').checked;
            document.getElementById('longTermBenefits').style.display = isLongTerm ? 'block' : 'none';
            
            if (isLongTerm) {
                // é•·æœŸå„ªè‰¯ä½å®…ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®š
                document.getElementById('loanDeduction').value = 35;
            } else {
                // é€šå¸¸ä½å®…ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã«æˆ»ã™
                document.getElementById('loanDeduction').value = 25;
            }
        }

        // ä»‹è­·è²»ç”¨ã®è¡¨ç¤ºåˆ‡æ›¿
        function toggleCareSettings() {
            const hasCare = document.getElementById('hasCare').checked;
            document.getElementById('careSettings').style.display = hasCare ? 'block' : 'none';
        }

        // ãƒ—ãƒªã‚»ãƒƒãƒˆèª­ã¿è¾¼ã¿
        function loadPreset(type) {
            const presets = {
                average: {
                    person1Age: 35, person2Age: 33, totalIncome: 800, numChildren: 2,
                    propertyPrice: 5000, downPayment: 500, person1Income: 500, person2Income: 300
                },
                dualIncome: {
                    person1Age: 30, person2Age: 28, totalIncome: 1200, numChildren: 1,
                    propertyPrice: 6500, downPayment: 1000, person1Income: 700, person2Income: 500
                },
                highIncome: {
                    person1Age: 40, person2Age: 38, totalIncome: 1800, numChildren: 2,
                    propertyPrice: 8000, downPayment: 2000, person1Income: 1200, person2Income: 600
                },
                single: {
                    person1Age: 32, person2Age: 0, totalIncome: 600, numChildren: 0,
                    propertyPrice: 4000, downPayment: 500, person1Income: 600, person2Income: 0
                }
            };

            const preset = presets[type];
            for (let key in preset) {
                const elem = document.getElementById(key);
                if (elem) {
                    elem.value = preset[key];
                    if (elem.type === 'range') {
                        updateSlider(key);
                    }
                }
            }

            // å­ã©ã‚‚ã®å¹´é½¢è¨­å®š
            const num = preset.numChildren;
            document.getElementById('child1Age').value = num >= 1 ? 5 : 0;
            document.getElementById('child2Age').value = num >= 2 ? 3 : 0;
            document.getElementById('child3Age').value = num >= 3 ? -2 : 0;

            // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã¨è¡¨ç¤ºã‚’é€£å‹•
            document.getElementById('child1Enabled').checked = num >= 1;
            document.getElementById('child2Enabled').checked = num >= 2;
            document.getElementById('child3Enabled').checked = num >= 3;

            for (let i = 1; i <= 3; i++) {
                toggleChildSection(i);
            }
        }

        // å­ã©ã‚‚å¹´é½¢ã«å¿œã˜ãŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ï¼ˆç”£ä¼‘è¡¨ç¤º/éè¡¨ç¤ºã®åˆ‡æ›¿ï¼‰
        function updateChildStatus(childNum) {
            const ageInput = document.getElementById(`child${childNum}Age`);
            const age = parseInt(ageInput.value) || 0;

            const maternityDetails = document.getElementById(`child${childNum}MaternityDetails`);
            const maternityStartInput = document.getElementById(`child${childNum}MaternityStart`);
            const statusBadge = document.getElementById(`child${childNum}StatusBadge`);
            const birthTimingSpan = document.getElementById(`child${childNum}BirthTiming`);

            if (age <= 0) {
                // æœªæ¥ã®å­ã©ã‚‚ or æ–°ç”Ÿå…ï¼šç”£ä¼‘è¨­å®šã‚’è¡¨ç¤º
                const maternityStartYear = Math.max(0, Math.abs(age));

                if (maternityStartInput) {
                    maternityStartInput.value = maternityStartYear;
                }
                if (maternityDetails) {
                    maternityDetails.style.display = 'block';
                }
                if (statusBadge) {
                    if (age === 0) {
                        statusBadge.textContent = 'æ–°ç”Ÿå…';
                        statusBadge.style.background = '#fff3e0';
                        statusBadge.style.color = '#e65100';
                    } else {
                        statusBadge.textContent = 'å‡ºç”£äºˆå®š';
                        statusBadge.style.background = '#fce4ec';
                        statusBadge.style.color = '#c62828';
                    }
                }
                if (birthTimingSpan) {
                    if (age === 0) {
                        birthTimingSpan.textContent = 'ä»Šå¹´';
                    } else {
                        birthTimingSpan.textContent = Math.abs(age) + 'å¹´å¾Œ';
                    }
                }
            } else {
                // æ—¢å­˜ã®å­ã©ã‚‚ï¼šç”£ä¼‘è¨­å®šã‚’éè¡¨ç¤º
                if (maternityDetails) {
                    maternityDetails.style.display = 'none';
                }
                if (statusBadge) {
                    statusBadge.textContent = 'å‡ºç”Ÿæ¸ˆã¿';
                    statusBadge.style.background = '#e8f5e9';
                    statusBadge.style.color = '#2e7d32';
                }
            }
        }

        // å­ã©ã‚‚å€‹åˆ¥ã®ON/OFFåˆ‡ã‚Šæ›¿ãˆï¼ˆçµ±åˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼‰
        function toggleChildSection(childNum) {
            const enabled = document.getElementById(`child${childNum}Enabled`).checked;

            // çµ±åˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®è©³ç´°éƒ¨åˆ†ã‚’è¡¨ç¤º/éè¡¨ç¤º
            const details = document.getElementById(`child${childNum}Details`);
            if (details) {
                details.style.display = enabled ? 'block' : 'none';
            }

            // æœ‰åŠ¹ãªå ´åˆã€å¹´é½¢ã«å¿œã˜ãŸç”£ä¼‘è¡¨ç¤ºã‚’æ›´æ–°
            if (enabled) {
                updateChildStatus(childNum);
            }
        }

        // ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ãƒˆã‚°ãƒ«
        function toggleAccordion(header) {
            const body = header.nextElementSibling;
            header.classList.toggle('open');
            body.classList.toggle('open');
        }

        // ãã®ä»–ãƒ­ãƒ¼ãƒ³ã®è¿½åŠ 
        let otherLoanCount = 1;
        function addOtherLoan() {
            const container = document.getElementById('otherLoansContainer');
            const idx = otherLoanCount++;
            const div = document.createElement('div');
            div.className = 'other-loan-item';
            div.setAttribute('data-loan-index', idx);
            div.style.cssText = 'background: white; padding: 12px; border-radius: 8px; margin-bottom: 8px; border: 1px solid #e0e0e0;';
            div.innerHTML = `
                <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                    <input type="text" class="otherLoanName" value="" placeholder="åç§°" style="width: 100px; padding: 8px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                    <input type="number" class="otherLoanAmount" value="0" step="0.5" min="0" style="width: 80px; padding: 8px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                    <span style="font-size: 13px; color: #666;">ä¸‡å††/æœˆ</span>
                    <span style="font-size: 13px; color: #666; margin-left: 8px;">æ®‹ã‚Š</span>
                    <input type="number" class="otherLoanYears" value="0" step="1" min="0" max="50" style="width: 60px; padding: 8px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                    <span style="font-size: 13px; color: #666;">å¹´</span>
                    <button type="button" onclick="removeOtherLoan(this)" style="margin-left: auto; padding: 4px 12px; background: #dc3545; color: white; border: none; border-radius: 15px; font-size: 12px; cursor: pointer;">âœ•</button>
                </div>
            `;
            container.appendChild(div);
        }

        function removeOtherLoan(btn) {
            btn.closest('.other-loan-item').remove();
        }

        // ãã®ä»–ãƒ­ãƒ¼ãƒ³ã®åˆè¨ˆã‚’å¹´ã”ã¨ã«å–å¾—
        function getOtherLoansForYear(year) {
            const items = document.querySelectorAll('.other-loan-item:not(.person2-work-pattern)');
            let total = 0;
            items.forEach(item => {
                const amountEl = item.querySelector('.otherLoanAmount');
                const yearsEl = item.querySelector('.otherLoanYears');
                if (!amountEl || !yearsEl) return;
                const amount = parseFloat(amountEl.value) || 0;
                const years = parseInt(yearsEl.value) || 0;
                if (amount > 0) {
                    if (years === 0 || year < years) {
                        total += amount * 12;
                    }
                }
            });
            return total;
        }

        // é…å¶è€…ã®å°±åŠ´å½¢æ…‹åˆ‡ã‚Šæ›¿ãˆï¼ˆå¾Œæ–¹äº’æ›ç”¨ãƒ»æ–°UIã§ã¯ä¸ä½¿ç”¨ï¼‰
        function togglePerson2WorkSettings() {}

        // é…å¶è€…ã®å°±åŠ´ãƒ‘ã‚¿ãƒ¼ãƒ³è¿½åŠ 
        let workPatternCount = 1;
        function addWorkPattern() {
            const container = document.getElementById('person2WorkPatternsContainer');
            const index = workPatternCount;
            workPatternCount++;
            const div = document.createElement('div');
            div.className = 'other-loan-item person2-work-pattern';
            div.dataset.patternIndex = index;
            div.style.cssText = 'margin-bottom: 12px; padding: 12px; background: #f5f7fa; border-radius: 8px; border-left: 3px solid #2c5f8a;';
            div.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <span style="font-weight: 600; font-size: 14px; color: #1a3a5c;">ãƒ‘ã‚¿ãƒ¼ãƒ³${index + 1}</span>
                    <button type="button" onclick="removeWorkPattern(this)" style="background: #ff5757; color: white; border: none; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;">âœ• å‰Šé™¤</button>
                </div>
                <div class="input-row" style="margin-bottom: 6px;">
                    <div class="input-group">
                        <div class="input-label">å°±åŠ´å½¢æ…‹</div>
                        <div class="input-wrapper">
                            <select class="workPatternType">
                                <option value="fulltime">ãƒ•ãƒ«ã‚¿ã‚¤ãƒ </option>
                                <option value="parttime" selected>ãƒ‘ãƒ¼ãƒˆãƒ»æ™‚çŸ­å‹¤å‹™</option>
                                <option value="homemaker">å°‚æ¥­ä¸»å©¦ï¼ˆä¸»å¤«ï¼‰</option>
                            </select>
                        </div>
                    </div>
                    <div class="input-group">
                        <div class="input-label">å¹´åï¼ˆé¡é¢ï¼‰</div>
                        <div class="input-wrapper">
                            <input type="number" class="workPatternIncome" value="120" step="10" min="0">
                            <span class="unit-label">ä¸‡å††</span>
                        </div>
                    </div>
                </div>
                <div class="input-row">
                    <div class="input-group">
                        <div class="input-label">é–‹å§‹</div>
                        <div class="input-wrapper">
                            <input type="number" class="workPatternStart" value="0" min="0" max="60">
                            <span class="unit-label">å¹´å¾Œ</span>
                        </div>
                    </div>
                    <div class="input-group">
                        <div class="input-label">çµ‚äº†</div>
                        <div class="input-wrapper">
                            <input type="number" class="workPatternEnd" value="10" min="0" max="60">
                            <span class="unit-label">å¹´å¾Œ</span>
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(div);
        }

        function removeWorkPattern(btn) {
            const item = btn.closest('.person2-work-pattern');
            if (item) item.remove();
        }

        // å°±åŠ´ãƒ‘ã‚¿ãƒ¼ãƒ³ã‹ã‚‰ãã®å¹´ã®åå…¥ã‚’è¨ˆç®—ï¼ˆæ‰‹å–ã‚Šå¤‰æ›ã‚ã‚Šï¼‰
        function getPerson2IncomeForYear(year, person2Growth, person2Retire, age2, person2Pension) {
            if (age2 >= person2Retire) return person2Pension;

            const patterns = document.querySelectorAll('.person2-work-pattern');
            let matchedIncome = 0;
            let matched = false;

            patterns.forEach(p => {
                const typeEl = p.querySelector('.workPatternType');
                const incomeEl = p.querySelector('.workPatternIncome');
                const startEl = p.querySelector('.workPatternStart');
                const endEl = p.querySelector('.workPatternEnd');
                if (!typeEl || !incomeEl) return;
                const type = typeEl.value;
                const incomeGross = parseFloat(incomeEl.value) || 0;
                const start = parseInt(startEl?.value) || 0;
                const end = parseInt(endEl?.value) || 60;

                if (year >= start && year < end) {
                    matched = true;
                    if (type === 'homemaker') {
                        matchedIncome = 0;
                    } else {
                        matchedIncome = calculateTakeHome(incomeGross) * Math.pow(1 + person2Growth, year);
                    }
                }
            });

            if (!matched) return 0;
            return matchedIncome;
        }

        // æ¯”è¼ƒãƒ¢ãƒ¼ãƒ‰ãƒˆã‚°ãƒ«
        function toggleComparisonMode() {
            const isCompare = document.getElementById('compareRates').checked;
            document.getElementById('normalRateMode').style.display = isCompare ? 'none' : 'block';
            document.getElementById('comparisonRateMode').style.display = isCompare ? 'block' : 'none';
            if (isCompare) {
                updateScenarioDescription();
            }
        }

        // ã‚·ãƒŠãƒªã‚ªèª¬æ˜ã‚’æ›´æ–°
        function updateScenarioDescription() {
            const scenario = document.getElementById('rateScenario').value;
            const descriptions = {
                optimistic: 'ğŸ“Š <strong>æ¥½è¦³ã‚·ãƒŠãƒªã‚ªï¼š</strong>ä½é‡‘åˆ©ãŒé•·æœŸé–“ç¶™ç¶šã€‚å¹´é–“+0.02%ã®ç·©ã‚„ã‹ãªä¸Šæ˜‡ã€‚æ—¥æœ¬ã®2010å¹´ä»£ã®ã‚ˆã†ãªçŠ¶æ³ã‚’æƒ³å®šã€‚',
                standard: 'ğŸ“Š <strong>æ¨™æº–ã‚·ãƒŠãƒªã‚ªï¼š</strong>æ™¯æ°—å›å¾©ã«ä¼´ã„å¾ã€…ã«é‡‘åˆ©ä¸Šæ˜‡ã€‚å¹´é–“+0.05%ç¨‹åº¦ã®ä¸Šæ˜‡ã€‚10å¹´å¾Œã«ç´„1.0%åˆ°é”ã€‚',
                pessimistic: 'ğŸ“Š <strong>æ‚²è¦³ã‚·ãƒŠãƒªã‚ªï¼š</strong>æ€¥æ¿€ãªã‚¤ãƒ³ãƒ•ãƒ¬ã‚„é‡‘èæ”¿ç­–å¤‰æ›´ã€‚å¹´é–“+0.15%ã®ä¸Šæ˜‡ã€‚10å¹´å¾Œã«ç´„2.0%åˆ°é”ã€‚'
            };
            document.getElementById('scenarioDescription').innerHTML = descriptions[scenario];
        }


        // æ‰‹å–ã‚Šè¨ˆç®—é–¢æ•°ï¼ˆå¹´åã‹ã‚‰ç¨é‡‘ãƒ»ç¤¾ä¼šä¿é™ºæ–™ã‚’æ§é™¤ï¼‰
        function calculateTakeHome(grossIncome) {
            if (grossIncome <= 0) return 0;
            
            // çµ¦ä¸æ‰€å¾—æ§é™¤
            let employmentDeduction;
            if (grossIncome <= 162.5) {
                employmentDeduction = 55;
            } else if (grossIncome <= 180) {
                employmentDeduction = grossIncome * 0.4 - 10;
            } else if (grossIncome <= 360) {
                employmentDeduction = grossIncome * 0.3 + 8;
            } else if (grossIncome <= 660) {
                employmentDeduction = grossIncome * 0.2 + 44;
            } else if (grossIncome <= 850) {
                employmentDeduction = grossIncome * 0.1 + 110;
            } else {
                employmentDeduction = 195;
            }
            
            // ç¤¾ä¼šä¿é™ºæ–™ï¼ˆç´„15%ï¼‰
            const socialInsurance = grossIncome * 0.15;
            
            // èª²ç¨æ‰€å¾—
            const taxableIncome = Math.max(0, grossIncome - employmentDeduction - socialInsurance);
            
            // æ‰€å¾—ç¨ï¼ˆç´¯é€²èª²ç¨ï¼‰
            let incomeTax;
            if (taxableIncome <= 195) {
                incomeTax = taxableIncome * 0.05;
            } else if (taxableIncome <= 330) {
                incomeTax = taxableIncome * 0.1 - 9.75;
            } else if (taxableIncome <= 695) {
                incomeTax = taxableIncome * 0.2 - 42.75;
            } else if (taxableIncome <= 900) {
                incomeTax = taxableIncome * 0.23 - 63.6;
            } else if (taxableIncome <= 1800) {
                incomeTax = taxableIncome * 0.33 - 153.6;
            } else {
                incomeTax = taxableIncome * 0.4 - 279.6;
            }
            
            // ä½æ°‘ç¨ï¼ˆç´„10%ï¼‰
            const residentTax = taxableIncome * 0.1;
            
            // æ‰‹å–ã‚Š
            const takeHome = grossIncome - socialInsurance - incomeTax - residentTax;
            return Math.max(0, takeHome);
        }

        // è¨ˆç®—ãƒ¡ã‚¤ãƒ³é–¢æ•°
        function calculate() {
            // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            const propertyPrice = parseFloat(document.getElementById('propertyPrice').value);
            const downPayment = parseFloat(document.getElementById('downPayment').value);
            
            if (propertyPrice <= 0) {
                alert('ç‰©ä»¶ä¾¡æ ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            if (downPayment > propertyPrice) {
                alert('é ­é‡‘ãŒç‰©ä»¶ä¾¡æ ¼ã‚’è¶…ãˆã¦ã„ã¾ã™');
                return;
            }
            
            const isCompareMode = document.getElementById('compareRates').checked;
            
            if (isCompareMode) {
                calculateWithComparison();
            } else {
                calculateNormal();
            }
        }

        // é€šå¸¸è¨ˆç®—
        function calculateNormal() {
            try {
                // å…¥åŠ›å€¤å–å¾—
            const person1Age = parseInt(document.getElementById('person1Age').value);
            const person2Age = parseInt(document.getElementById('person2Age').value);
            const person1IncomeGross = parseFloat(document.getElementById('person1Income').value);
            const person2IncomeGross = parseFloat(document.getElementById('person2Income').value);
            // å¹´åã‚’æ‰‹å–ã‚Šã«å¤‰æ›
            const person1Income = calculateTakeHome(person1IncomeGross);
            const person2Income = calculateTakeHome(person2IncomeGross);
            const person1Growth = parseFloat(document.getElementById('person1Growth').value) / 100;
            const person2Growth = parseFloat(document.getElementById('person2Growth').value) / 100;
            const person1Retire = parseInt(document.getElementById('person1Retire').value);
            const person2Retire = parseInt(document.getElementById('person2Retire').value);
            const person1Pension = parseFloat(document.getElementById('person1Pension').value);
            const person2Pension = parseFloat(document.getElementById('person2Pension').value);
            const person1Retirement = parseFloat(document.getElementById('person1Retirement').value);
            const person2Retirement = parseFloat(document.getElementById('person2Retirement').value);

            // é…å¶è€…ã®å°±åŠ´å½¢æ…‹
            const person2WorkType = document.getElementById('person2WorkType').value;
            const person2WorkStart = parseInt(document.getElementById('person2WorkStart').value) || 0;
            const person2WorkEnd = parseInt(document.getElementById('person2WorkEnd').value) || 30;
            const person2PartIncomeGross = parseFloat(document.getElementById('person2PartIncome').value) || 120;
            const person2PartIncome = calculateTakeHome(person2PartIncomeGross);

            // å­ã©ã‚‚ã®å€‹åˆ¥æœ‰åŠ¹/ç„¡åŠ¹ãƒã‚§ãƒƒã‚¯
            const child1Enabled = document.getElementById('child1Enabled')?.checked ?? false;
            const child2Enabled = document.getElementById('child2Enabled')?.checked ?? false;
            const child3Enabled = document.getElementById('child3Enabled')?.checked ?? false;
            
            const child1Age = child1Enabled ? parseInt(document.getElementById('child1Age').value) : 0;
            const child2Age = child2Enabled ? parseInt(document.getElementById('child2Age').value) : 0;
            const child3Age = child3Enabled ? parseInt(document.getElementById('child3Age').value) : 0;

            const propertyPrice = parseFloat(document.getElementById('propertyPrice').value);
            const downPayment = parseFloat(document.getElementById('downPayment').value);
            const interestRate = parseFloat(document.getElementById('interestRate').value) / 100;
            const loanTerm = parseInt(document.getElementById('loanTerm').value);
            const repaymentMethod = document.getElementById('repaymentMethod').value;
            const loanStartYear = parseInt(document.getElementById('loanStartYear').value);
            const propertyTax = parseFloat(document.getElementById('propertyTax').value);
            const loanDeduction = parseFloat(document.getElementById('loanDeduction').value);
            const currentRent = parseFloat(document.getElementById('currentRent').value) * 12;

            const basicLiving = parseFloat(document.getElementById('basicLiving').value) * 12;
            const inflationRate = parseFloat(document.getElementById('inflationRate').value) / 100;
            const carCost = parseFloat(document.getElementById('carCost').value);
            const communication = parseFloat(document.getElementById('communication').value) * 12;
            const allowance = parseFloat(document.getElementById('allowance').value) * 12;
            // otherLoanã¯å¹´ã”ã¨ã«å‹•çš„è¨ˆç®—ã™ã‚‹ãŸã‚ã€ã“ã“ã§ã¯å–å¾—ã—ãªã„

            // å­ã©ã‚‚åˆ¥ã®æ•™è‚²è²»è¨­å®š
            const child1Elementary = parseFloat(document.getElementById('child1Elementary').value);
            const child1JuniorHigh = parseFloat(document.getElementById('child1JuniorHigh').value);
            const child1HighSchool = parseFloat(document.getElementById('child1HighSchool').value);
            const child1University = parseFloat(document.getElementById('child1University').value);
            
            const child2Elementary = parseFloat(document.getElementById('child2Elementary').value);
            const child2JuniorHigh = parseFloat(document.getElementById('child2JuniorHigh').value);
            const child2HighSchool = parseFloat(document.getElementById('child2HighSchool').value);
            const child2University = parseFloat(document.getElementById('child2University').value);
            
            const child3Elementary = parseFloat(document.getElementById('child3Elementary').value);
            const child3JuniorHigh = parseFloat(document.getElementById('child3JuniorHigh').value);
            const child3HighSchool = parseFloat(document.getElementById('child3HighSchool').value);
            const child3University = parseFloat(document.getElementById('child3University').value);

            // ä»‹è­·è²»ç”¨
            const hasCare = document.getElementById('hasCare').checked;
            const careStartAge = hasCare ? parseInt(document.getElementById('careStartAge').value) : 0;
            const careDuration = hasCare ? parseInt(document.getElementById('careDuration').value) : 0;
            const careCostMonthly = hasCare ? parseFloat(document.getElementById('careCost').value) : 0;
            const careInsuranceRate = hasCare ? parseFloat(document.getElementById('careInsuranceRate').value) : 0;
            const careCostAnnual = careCostMonthly * 12 * careInsuranceRate; // è‡ªå·±è² æ‹…åˆ†ã®ã¿

            const lifeInsurance = parseFloat(document.getElementById('lifeInsurance').value) * 12;
            const propertyInsurance = parseFloat(document.getElementById('propertyInsurance').value) * 12;
            const fireInsurance = parseFloat(document.getElementById('fireInsurance').value) || 20; // 5å¹´åˆ†ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ20ä¸‡å††ï¼‰
            const savingsStart = parseFloat(document.getElementById('savingsStart').value);
            
            // ä¸€æ‹¬æŠ•è³‡
            const lumpSumInvestment = parseFloat(document.getElementById('lumpSumInvestment').value) || 0;
            const lumpSumReturn = parseFloat(document.getElementById('lumpSumReturn').value) / 100;
            const lumpSumYears = parseInt(document.getElementById('lumpSumYears').value) || 30;
            
            // ç©ç«‹æŠ•è³‡
            const monthlyInvestment = parseFloat(document.getElementById('monthlyInvestment').value);
            const monthlyReturn = parseFloat(document.getElementById('monthlyReturn').value) / 100;
            const investmentYears = parseInt(document.getElementById('investmentYears').value); // ç©ç«‹æœŸé–“
            const monthlyInvYears = investmentYears; // é‹ç”¨æœŸé–“ = ç©ç«‹æœŸé–“ï¼ˆç©ç«‹çµ‚äº†å¾Œã¯åˆ©å›ã‚Š0%ï¼‰

            // ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
            const getValueOrZero = (id) => {
                const elem = document.getElementById(id);
                return elem ? (parseFloat(elem.value) || 0) : 0;
            };
            const getIntOrZero = (id) => {
                const elem = document.getElementById(id);
                return elem ? (parseInt(elem.value) || 0) : 0;
            };

            // ç”£ä¼‘ãƒ»è‚²ä¼‘ï¼ˆå­ã©ã‚‚åˆ¥ï¼‰
            const child1MaternityStart = getIntOrZero('child1MaternityStart');
            const child1MaternityDuration = getValueOrZero('child1MaternityDuration');
            const child1MaternityAllowance = getValueOrZero('child1MaternityAllowance') * 12;
            const child1ReturnWorkRate = getValueOrZero('child1ReturnWorkRate') / 100;
            
            const child2MaternityStart = getIntOrZero('child2MaternityStart');
            const child2MaternityDuration = getValueOrZero('child2MaternityDuration');
            const child2MaternityAllowance = getValueOrZero('child2MaternityAllowance') * 12;
            const child2ReturnWorkRate = getValueOrZero('child2ReturnWorkRate') / 100;
            
            const child3MaternityStart = getIntOrZero('child3MaternityStart');
            const child3MaternityDuration = getValueOrZero('child3MaternityDuration');
            const child3MaternityAllowance = getValueOrZero('child3MaternityAllowance') * 12;
            const child3ReturnWorkRate = getValueOrZero('child3ReturnWorkRate') / 100;

            // è‡¨æ™‚æ”¯å‡º
            const temp1Amount = getValueOrZero('temp1Amount');
            const temp1Year = getIntOrZero('temp1Year');
            const temp1Repeat = getIntOrZero('temp1Repeat');
            
            const temp2Amount = getValueOrZero('temp2Amount');
            const temp2Year = getIntOrZero('temp2Year');
            const temp2Repeat = getIntOrZero('temp2Repeat');
            
            const temp3Amount = getValueOrZero('temp3Amount');
            const temp3Year = getIntOrZero('temp3Year');
            const temp3Repeat = getIntOrZero('temp3Repeat');
            
            const temp4Amount = getValueOrZero('temp4Amount');
            const temp4Year = getIntOrZero('temp4Year');
            const temp4Repeat = getIntOrZero('temp4Repeat');
            
            const temp5Amount = getValueOrZero('temp5Amount');
            const temp5Year = getIntOrZero('temp5Year');
            const temp5Repeat = getIntOrZero('temp5Repeat');

            // é•·æœŸå„ªè‰¯ä½å®…
            const isLongTerm = document.getElementById('isLongTerm').checked;
            const longTermTaxSaving = isLongTerm ? parseFloat(document.getElementById('longTermTaxSaving').value) : 0;
            const taxReductionYears = isLongTerm ? parseInt(document.getElementById('taxReductionYears').value) : 0;

            // ä½å®…ãƒ­ãƒ¼ãƒ³è¨ˆç®—
            const loanAmount = propertyPrice - downPayment;
            const monthlyRate = interestRate / 12;
            const numPayments = loanTerm * 12;
            
            // ãƒ­ãƒ¼ãƒ³è¿”æ¸ˆã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¨ˆç®—ï¼ˆè¿”æ¸ˆæ–¹æ³•ã«ã‚ˆã‚Šåˆ†å²ï¼‰
            const loanSchedule = [];
            let balance = loanAmount;
            
            if (repaymentMethod === 'equal_payment') {
                // å…ƒåˆ©é‡‘ç­‰ï¼ˆæ¯æœˆä¸€å®šï¼‰
                let monthlyPayment = 0;
                if (interestRate === 0) {
                    monthlyPayment = loanAmount / numPayments;
                } else {
                    monthlyPayment = loanAmount * (monthlyRate * Math.pow(1 + monthlyRate, numPayments)) / 
                                    (Math.pow(1 + monthlyRate, numPayments) - 1);
                }
                
                for (let year = 1; year <= loanTerm; year++) {
                    let yearPrincipal = 0;
                    let yearInterest = 0;
                    for (let month = 1; month <= 12; month++) {
                        const interest = balance * monthlyRate;
                        const principal = monthlyPayment - interest;
                        balance -= principal;
                        if (balance < 0) balance = 0;
                        yearPrincipal += principal;
                        yearInterest += interest;
                    }
                    loanSchedule.push({
                        year: year,
                        payment: monthlyPayment * 12,
                        principal: yearPrincipal,
                        interest: yearInterest,
                        balance: balance
                    });
                }
            } else {
                // å…ƒé‡‘å‡ç­‰ï¼ˆå…ƒé‡‘ä¸€å®šï¼‰
                const monthlyPrincipal = loanAmount / numPayments;
                
                for (let year = 1; year <= loanTerm; year++) {
                    let yearPrincipal = 0;
                    let yearInterest = 0;
                    let yearPayment = 0;
                    
                    for (let month = 1; month <= 12; month++) {
                        const interest = balance * monthlyRate;
                        const payment = monthlyPrincipal + interest;
                        balance -= monthlyPrincipal;
                        if (balance < 0) balance = 0;
                        
                        yearPrincipal += monthlyPrincipal;
                        yearInterest += interest;
                        yearPayment += payment;
                    }
                    
                    loanSchedule.push({
                        year: year,
                        payment: yearPayment,
                        principal: yearPrincipal,
                        interest: yearInterest,
                        balance: balance
                    });
                }
            }

            // åˆå¹´åº¦ã®è¿”æ¸ˆé¡ã‚’å–å¾—
            const annualLoanPayment = loanSchedule.length > 0 ? loanSchedule[0].payment : 0;

            // 60å¹´é–“ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼è¨ˆç®—
            cashflowData = [];
            let savings = savingsStart; // è²¯è“„ï¼ˆæ™®é€šé é‡‘ãƒ»é‹ç”¨ãªã—ï¼‰
            let lumpSumInv = lumpSumInvestment; // ä¸€æ‹¬æŠ•è³‡ï¼ˆåˆ¥ã€…ã®åˆ©å›ã‚Šï¼‰
            let monthlyInv = 0; // ç©ç«‹æŠ•è³‡ï¼ˆåˆ¥ã€…ã®åˆ©å›ã‚Šï¼‰
            let minSavings = savingsStart;
            let minSavingsYear = 0;
            let totalIncome = 0;
            let totalExpense = 0;

            for (let year = 0; year < 60; year++) {
                const age1 = person1Age + year;
                const age2 = person2Age > 0 ? person2Age + year : 0;
                const ageChild1 = child1Enabled ? child1Age + year : 0;
                const ageChild2 = child2Enabled ? child2Age + year : 0;
                const ageChild3 = child3Enabled ? child3Age + year : 0;

                // åå…¥è¨ˆç®—
                let income1 = 0;
                if (age1 < person1Retire) {
                    income1 = person1Income * Math.pow(1 + person1Growth, year);
                } else {
                    income1 = person1Pension;
                }

                // é…å¶è€…åå…¥ï¼ˆå°±åŠ´ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒ™ãƒ¼ã‚¹ + ç”£ä¼‘è‚²ä¼‘è€ƒæ…®ï¼‰
                let income2 = 0;
                if (person2Age > 0) {
                    let baseIncome2 = getPerson2IncomeForYear(year, person2Growth, person2Retire, age2, person2Pension);

                    // ç”£ä¼‘è‚²ä¼‘ãƒã‚§ãƒƒã‚¯ï¼ˆbaseIncomeãŒ0ã§ãªã„ï¼å°±åŠ´ä¸­ã®å ´åˆã®ã¿ï¼‰
                    if (baseIncome2 > 0 && age2 < person2Retire) {
                        let isOnMaternity = false;
                        let maternityIncome = 0;
                        let isReturning = false;
                        let returningRate = 1.0;

                        if (child1Enabled && child1Age <= 0) {
                            if (year >= child1MaternityStart && year < child1MaternityStart + child1MaternityDuration) {
                                isOnMaternity = true;
                                maternityIncome = child1MaternityAllowance;
                            } else if (year >= child1MaternityStart + child1MaternityDuration && year < child1MaternityStart + child1MaternityDuration + 3) {
                                isReturning = true;
                                returningRate = Math.min(returningRate, child1ReturnWorkRate);
                            }
                        }

                        if (child2Enabled && child2Age <= 0) {
                            if (year >= child2MaternityStart && year < child2MaternityStart + child2MaternityDuration) {
                                isOnMaternity = true;
                                maternityIncome = child2MaternityAllowance;
                            } else if (year >= child2MaternityStart + child2MaternityDuration && year < child2MaternityStart + child2MaternityDuration + 3) {
                                isReturning = true;
                                returningRate = Math.min(returningRate, child2ReturnWorkRate);
                            }
                        }

                        if (child3Enabled && child3Age <= 0) {
                            if (year >= child3MaternityStart && year < child3MaternityStart + child3MaternityDuration) {
                                isOnMaternity = true;
                                maternityIncome = child3MaternityAllowance;
                            } else if (year >= child3MaternityStart + child3MaternityDuration && year < child3MaternityStart + child3MaternityDuration + 3) {
                                isReturning = true;
                                returningRate = Math.min(returningRate, child3ReturnWorkRate);
                            }
                        }

                        if (isOnMaternity) {
                            income2 = maternityIncome;
                        } else if (isReturning) {
                            income2 = baseIncome2 * returningRate;
                        } else {
                            income2 = baseIncome2;
                        }
                    } else {
                        income2 = baseIncome2;
                    }
                }

                // é€€è·é‡‘
                let retirement = 0;
                if (year > 0 && age1 === person1Retire) retirement += person1Retirement;
                if (person2Age > 0 && year > 0 && age2 === person2Retire) retirement += person2Retirement;

                // å…ç«¥æ‰‹å½“ï¼ˆ2024å¹´10æœˆæ”¹æ­£ç‰ˆï¼šæ‰€å¾—åˆ¶é™æ’¤å»ƒï¼‰
                let childAllowance = 0;
                const addChildAllowance = (age, childNum) => {
                    if (age >= 0 && age < 3) {
                        // 0-2æ­³ï¼šç¬¬3å­ä»¥é™ã¯æœˆ3ä¸‡å††ã€ãã‚Œä»¥å¤–ã¯æœˆ1.5ä¸‡å††
                        return childNum >= 3 ? 36 : 18;
                    } else if (age >= 3 && age < 18) {
                        // 3æ­³ã€œé«˜æ ¡å’æ¥­ï¼šç¬¬3å­ä»¥é™ã¯æœˆ3ä¸‡å††ã€ãã‚Œä»¥å¤–ã¯æœˆ1ä¸‡å††
                        return childNum >= 3 ? 36 : 12;
                    }
                    return 0;
                };
                
                // å­ã©ã‚‚ã®é †ç•ªã‚’è€ƒæ…®
                let childCount = 0;
                if (child1Enabled && ageChild1 >= 0) {
                    childCount++;
                    childAllowance += addChildAllowance(ageChild1, childCount);
                }
                if (child2Enabled && ageChild2 >= 0) {
                    childCount++;
                    childAllowance += addChildAllowance(ageChild2, childCount);
                }
                if (child3Enabled && ageChild3 >= 0) {
                    childCount++;
                    childAllowance += addChildAllowance(ageChild3, childCount);
                }

                // ä½å®…ãƒ­ãƒ¼ãƒ³æ§é™¤
                let deduction = 0;
                if (year >= loanStartYear && year < loanStartYear + 13) {
                    deduction = loanDeduction;
                }

                // é•·æœŸå„ªè‰¯ä½å®…ã®åˆå¹´åº¦å„ªé‡ï¼ˆç™»è¨˜ãƒ»ç¨é‡‘è»½æ¸›ï¼‰
                let longTermBonus = 0;
                if (isLongTerm && year === loanStartYear) {
                    longTermBonus = longTermTaxSaving;
                }

                const totalIncomeYear = income1 + income2 + retirement + childAllowance + deduction + longTermBonus;

                // æ”¯å‡ºè¨ˆç®—ï¼ˆç‰©ä¾¡ä¸Šæ˜‡ç‡ã‚’é©ç”¨ï¼‰
                const livingCost = basicLiving * Math.pow(1 + inflationRate, year);
                const carCostInflated = carCost * Math.pow(1 + inflationRate, year);
                const communicationInflated = communication * Math.pow(1 + inflationRate, year);
                const allowanceInflated = allowance * Math.pow(1 + inflationRate, year);
                
                // ä½å±…è²»ï¼ˆé•·æœŸå„ªè‰¯ä½å®…ã®å„ªé‡ã¨è¿”æ¸ˆæ–¹æ³•ã‚’åæ˜ ï¼‰
                let housingCost = 0;
                if (year >= loanStartYear && year < loanStartYear + loanTerm) {
                    // ãƒ­ãƒ¼ãƒ³è¿”æ¸ˆæœŸé–“ä¸­
                    const loanYear = year - loanStartYear + 1;
                    const annualPayment = loanSchedule[loanYear - 1].payment;
                    
                    let propertyTaxYear = propertyTax;
                    // é•·æœŸå„ªè‰¯ä½å®…ã®å›ºå®šè³‡ç”£ç¨æ¸›é¡æœŸé–“
                    if (isLongTerm && year < loanStartYear + taxReductionYears) {
                        propertyTaxYear = propertyTax * 0.5; // æ¸›é¡æœŸé–“ã¯åŠé¡
                    }
                    housingCost = annualPayment + propertyTaxYear;
                } else if (year >= loanStartYear + loanTerm) {
                    // ãƒ­ãƒ¼ãƒ³å®Œæ¸ˆå¾Œ
                    housingCost = propertyTax;
                } else {
                    // è³¼å…¥å‰
                    housingCost = currentRent;
                }

                // ä»‹è­·è²»ç”¨
                let careCostYear = 0;
                if (hasCare && age1 >= careStartAge && age1 < careStartAge + careDuration) {
                    careCostYear = careCostAnnual * Math.pow(1 + inflationRate, year); // ç‰©ä¾¡ä¸Šæ˜‡ç‡ã‚’é©ç”¨
                }

                // æ•™è‚²è²»ï¼ˆå­ã©ã‚‚åˆ¥ãƒ»ç‰©ä¾¡ä¸Šæ˜‡ç‡ã‚’é©ç”¨ï¼‰
                const calculateEducation = (age, elementary, juniorHigh, highSchool, university) => {
                    const baseEducation = (() => {
                        if (age >= 3 && age <= 11) return elementary; // å¹¼ç¨šåœ’ã€œå°å­¦æ ¡
                        if (age >= 12 && age <= 14) return juniorHigh;
                        if (age >= 15 && age <= 17) return highSchool;
                        if (age >= 18 && age <= 21) return university;
                        return 0;
                    })();
                    return baseEducation * Math.pow(1 + inflationRate, year);
                };
                
                let educationCost = 0;
                if (child1Enabled) {
                    educationCost += calculateEducation(ageChild1, child1Elementary, child1JuniorHigh, child1HighSchool, child1University);
                }
                if (child2Enabled) {
                    educationCost += calculateEducation(ageChild2, child2Elementary, child2JuniorHigh, child2HighSchool, child2University);
                }
                if (child3Enabled) {
                    educationCost += calculateEducation(ageChild3, child3Elementary, child3JuniorHigh, child3HighSchool, child3University);
                }

                const otherLoanYear = getOtherLoansForYear(year);
                const totalExpenseYear = livingCost + housingCost + carCostInflated + communicationInflated +
                                       allowanceInflated + educationCost + lifeInsurance +
                                       propertyInsurance + otherLoanYear + careCostYear;

                // ç©ç«‹æŠ•è³‡ï¼ˆç©ç«‹æœŸé–“å†…ã®ã¿ç©ç«‹ï¼‰
                let investmentContribution = 0;
                if (year < investmentYears) {
                    investmentContribution = monthlyInvestment * 12;
                    monthlyInv += investmentContribution; // ç©ç«‹æŠ•è³‡ã«è¿½åŠ 
                }
                
                // ä¸€æ‹¬æŠ•è³‡ã®é‹ç”¨ç›Šï¼ˆé‹ç”¨æœŸé–“å†…ã®ã¿åˆ©å›ã‚Šé©ç”¨ï¼‰
                if (year < lumpSumYears) {
                    lumpSumInv = lumpSumInv * (1 + lumpSumReturn);
                }
                // é‹ç”¨æœŸé–“çµ‚äº†å¾Œã¯åˆ©å›ã‚Š0%ã§ä¿æŒï¼ˆä½•ã‚‚ã—ãªã„ï¼‰
                
                // ç©ç«‹æŠ•è³‡ã®é‹ç”¨ç›Šï¼ˆé‹ç”¨æœŸé–“å†…ã®ã¿åˆ©å›ã‚Šé©ç”¨ï¼‰
                if (year < monthlyInvYears) {
                    monthlyInv = monthlyInv * (1 + monthlyReturn);
                }
                // é‹ç”¨æœŸé–“çµ‚äº†å¾Œã¯åˆ©å›ã‚Š0%ã§ä¿æŒï¼ˆä½•ã‚‚ã—ãªã„ï¼‰
                
                // æŠ•è³‡åˆè¨ˆ
                const investment = lumpSumInv + monthlyInv;

                // ç«ç½ä¿é™ºï¼ˆè³¼å…¥æ™‚ã¨5å¹´ã”ã¨ï¼‰
                let fireInsuranceCost = 0;
                if (year >= loanStartYear) {
                    const yearsSincePurchase = year - loanStartYear;
                    if (yearsSincePurchase === 0 || (yearsSincePurchase % 5 === 0)) {
                        fireInsuranceCost = fireInsurance;
                    }
                }

                // è‡¨æ™‚æ”¯å‡º
                let temporaryExpense = 0;
                const checkTemporaryExpense = (amount, startYear, repeat) => {
                    if (amount > 0 && year === startYear) return amount;
                    if (amount > 0 && repeat > 0 && year > startYear) {
                        if ((year - startYear) % repeat === 0) return amount;
                    }
                    return 0;
                };
                
                temporaryExpense += checkTemporaryExpense(temp1Amount, temp1Year, temp1Repeat);
                temporaryExpense += checkTemporaryExpense(temp2Amount, temp2Year, temp2Repeat);
                temporaryExpense += checkTemporaryExpense(temp3Amount, temp3Year, temp3Repeat);
                temporaryExpense += checkTemporaryExpense(temp4Amount, temp4Year, temp4Repeat);
                temporaryExpense += checkTemporaryExpense(temp5Amount, temp5Year, temp5Repeat);

                // å¹´é–“åæ”¯
                const annualCashflow = totalIncomeYear - totalExpenseYear - investmentContribution - fireInsuranceCost - temporaryExpense;
                
                // è²¯è“„è¨ˆç®—ï¼ˆé‹ç”¨ç›Šãªã—ãƒ»æ™®é€šé é‡‘ï¼‰
                savings = savings + annualCashflow;

                // é ­é‡‘æ”¯æ‰•ã„
                if (year === loanStartYear) {
                    savings -= downPayment;
                }
                
                // ç·è³‡ç”£ = è²¯è“„ + æŠ•è³‡
                const totalAssets = savings + investment;

                if (totalAssets < minSavings) {
                    minSavings = totalAssets;
                    minSavingsYear = year;
                }

                totalIncome += totalIncomeYear;
                totalExpense += totalExpenseYear + investmentContribution + fireInsuranceCost + temporaryExpense;

                cashflowData.push({
                    year: year,
                    age1: age1,
                    age2: age2,
                    ageChild1: ageChild1,
                    ageChild2: ageChild2,
                    ageChild3: ageChild3,
                    // åå…¥å†…è¨³
                    income1: income1,
                    income2: income2,
                    retirement: retirement,
                    childAllowance: childAllowance,
                    deduction: deduction,
                    longTermBonus: longTermBonus,
                    totalIncome: totalIncomeYear,
                    // æ”¯å‡ºå†…è¨³
                    livingCost: livingCost,
                    housingCost: housingCost,
                    carCost: carCostInflated,
                    communication: communicationInflated,
                    allowance: allowanceInflated,
                    educationCost: educationCost,
                    lifeInsurance: lifeInsurance,
                    propertyInsurance: propertyInsurance,
                    otherLoan: otherLoanYear,
                    careCost: careCostYear,
                    investmentContribution: investmentContribution,
                    fireInsurance: fireInsuranceCost,
                    temporaryExpense: temporaryExpense,
                    totalExpense: totalExpenseYear + investmentContribution + fireInsuranceCost + temporaryExpense,
                    // åæ”¯ãƒ»è³‡ç”£
                    annualCashflow: annualCashflow,
                    savings: savings,
                    investment: investment,
                    totalAssets: totalAssets
                });
            }

            // çµæœè¡¨ç¤º
            displaySummary(totalIncome, totalExpense, minSavings, minSavingsYear, 
                          cashflowData[59].totalAssets, annualLoanPayment, loanAmount, loanStartYear,
                          person1Age, loanTerm, child1Age, child2Age, child3Age);
            updateCharts(loanSchedule);
            updateTable();

            document.getElementById('results').classList.add('show');
            document.getElementById('results').scrollIntoView({ behavior: 'smooth', block: 'start' });
            } catch (error) {
                console.error('è¨ˆç®—ã‚¨ãƒ©ãƒ¼:', error);
                alert('è¨ˆç®—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚å…¥åŠ›å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚\n\nã‚¨ãƒ©ãƒ¼è©³ç´°: ' + error.message);
            }
        }

        function displaySummary(totalIncome, totalExpense, minSavings, minSavingsYear, finalSavings, annualLoan, loanAmount, loanStartYear, person1Age, loanTerm, child1Age, child2Age, child3Age) {
            // æŠ•è³‡çŠ¶æ³ã‚’ç¢ºèª
            const hasInvestment = cashflowData.some(d => d.investment > 0);
            const finalInvestment = cashflowData[59]?.investment || 0;
            const finalSavingsOnly = cashflowData[59]?.savings || 0;
            const investmentRatio = finalSavings > 0 ? (finalInvestment / finalSavings * 100) : 0;

            // ã‚¢ãƒ©ãƒ¼ãƒˆ
            let alertHTML = '';
            let alertClass = 'alert-box';
            if (minSavings < 0) {
                alertClass += '';
                alertHTML = `<p>âš ï¸ <strong>è­¦å‘Šï¼š</strong>${minSavingsYear + 1}å¹´ç›®ã«ç·è³‡ç”£ãŒãƒã‚¤ãƒŠã‚¹ï¼ˆ${formatMoney(minSavings)}ï¼‰ã«ãªã‚‹è¦‹è¾¼ã¿ã§ã™ã€‚</p>`;
                alertHTML += `<p style="margin-top:8px; font-size:13px; color:#666;">ğŸ’¡ æ”¯å‡ºã®è¦‹ç›´ã—ã‚„ã€åå…¥ã‚¢ãƒƒãƒ—ã®å¯èƒ½æ€§ã‚’æ¤œè¨ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚å°‘é¡ã‹ã‚‰ã®ç©ç«‹æŠ•è³‡ã§é•·æœŸçš„ãªè³‡ç”£å½¢æˆã‚’å§‹ã‚ã‚‹ã“ã¨ã‚‚ã€ãƒªã‚¹ã‚¯è»½æ¸›ã®ä¸€ã¤ã®æ–¹æ³•ã§ã™ã€‚</p>`;
            } else if (finalSavings < 1000) {
                alertHTML = `<p>âš ï¸ <strong>æ³¨æ„ï¼š</strong>60å¹´å¾Œã®ç·è³‡ç”£ãŒ${formatMoney(finalSavings)}ã®è¦‹è¾¼ã¿ã§ã™ã€‚</p>`;
                if (!hasInvestment) {
                    alertHTML += `<p style="margin-top:8px; font-size:13px; color:#666;">ğŸ’¡ ç¾åœ¨ã®è¨ˆç”»ã§ã¯æŠ•è³‡ã«ã‚ˆã‚‹é‹ç”¨ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ä½å®…è³¼å…¥ã¨ä¸¦è¡Œã—ã¦ã€å°‘é¡ã‹ã‚‰ã®ç©ç«‹æŠ•è³‡ã‚’æ´»ç”¨ã™ã‚‹ã“ã¨ã§ã€è€å¾Œè³‡é‡‘ã®æº–å‚™ã‚’ã‚ˆã‚ŠåŠ¹ç‡çš„ã«é€²ã‚ã‚‰ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚</p>`;
                } else if (investmentRatio < 30) {
                    alertHTML += `<p style="margin-top:8px; font-size:13px; color:#666;">ğŸ’¡ æŠ•è³‡ã«ã‚ˆã‚‹è³‡ç”£å½¢æˆãŒé€²ã‚“ã§ã„ã¾ã™ãŒã€ç©ç«‹é¡ã‚„é‹ç”¨æœŸé–“ã‚’è¦‹ç›´ã™ã“ã¨ã§ã€ã•ã‚‰ã«ã‚†ã¨ã‚Šã‚ã‚‹è€å¾Œè³‡é‡‘ã®æº–å‚™ãŒã§ãã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚</p>`;
                } else {
                    alertHTML += `<p style="margin-top:8px; font-size:13px; color:#666;">ğŸ’¡ ç©ç«‹æŠ•è³‡ã‚’æ´»ç”¨ã•ã‚Œã¦ã„ã¾ã™ã­ã€‚ç©ç«‹æœŸé–“ã®å»¶é•·ã‚„ã€æ”¯å‡ºã®è¦‹ç›´ã—ã§ç©ç«‹é¡ã‚’å¢—ã‚„ã™ã“ã¨ã‚‚æ¤œè¨ã—ã¦ã¿ã¦ãã ã•ã„ã€‚</p>`;
                }
            } else if (finalSavings < 3000) {
                alertClass += ' success';
                alertHTML = `<p>âœ… <strong>æ¦‚ã­è‰¯å¥½ï¼š</strong>è¨ˆç”»çš„ãªå®¶è¨ˆé‹å–¶ãŒã§ãã¦ã„ã¾ã™ã€‚</p>`;
                if (!hasInvestment) {
                    alertHTML += `<p style="margin-top:8px; font-size:13px; color:#555;">ğŸ’¡ ã•ã‚‰ã«ã‚†ã¨ã‚Šã‚ã‚‹å°†æ¥ã«å‘ã‘ã¦ã€å°‘é¡ã‹ã‚‰ã®ç©ç«‹æŠ•è³‡ã§è³‡ç”£é‹ç”¨ã‚’å§‹ã‚ã¦ã¿ã‚‹ã®ã‚‚ä¸€ã¤ã®é¸æŠè‚¢ã§ã™ã€‚æ™‚é–“ã‚’å‘³æ–¹ã«ã¤ã‘ãŸé•·æœŸé‹ç”¨ã¯ã€ä½å®…è³¼å…¥å¾Œã®è³‡ç”£å½¢æˆã«æœ‰åŠ¹ã§ã™ã€‚</p>`;
                } else {
                    alertHTML += `<p style="margin-top:8px; font-size:13px; color:#555;">ğŸ’¡ æŠ•è³‡ã‚’æ´»ç”¨ã—ãŸè³‡ç”£å½¢æˆãŒé€²ã‚“ã§ã„ã¾ã™ã€‚ã“ã®ãƒšãƒ¼ã‚¹ã‚’ç¶­æŒã—ã¤ã¤ã€ãƒ©ã‚¤ãƒ•ã‚¹ãƒ†ãƒ¼ã‚¸ã®å¤‰åŒ–ã«åˆã‚ã›ã¦è¦‹ç›´ã—ã¦ã„ãã¾ã—ã‚‡ã†ã€‚</p>`;
                }
            } else {
                alertClass += ' success';
                alertHTML = `<p>âœ… <strong>è‰¯å¥½ï¼š</strong>å®‰å®šã—ãŸå®¶è¨ˆé‹å–¶ã¨è³‡ç”£å½¢æˆãŒã§ãã¦ã„ã¾ã™ï¼</p>`;
                if (hasInvestment) {
                    alertHTML += `<p style="margin-top:8px; font-size:13px; color:#555;">ğŸ’¡ æŠ•è³‡è©•ä¾¡é¡ ${formatMoney(finalInvestment)} ã‚’å«ã‚ãŸç·è³‡ç”£ ${formatMoney(finalSavings)} ã®è¦‹è¾¼ã¿ã§ã™ã€‚ä½å®…è³¼å…¥ã¨è³‡ç”£å½¢æˆã®ãƒãƒ©ãƒ³ã‚¹ãŒå–ã‚ŒãŸè¨ˆç”»ã§ã™ã€‚</p>`;
                } else {
                    alertHTML += `<p style="margin-top:8px; font-size:13px; color:#555;">ğŸ’¡ è²¯è“„ã®ã¿ã§ ${formatMoney(finalSavings)} ã®è³‡ç”£å½¢æˆãŒè¦‹è¾¼ã‚ã¾ã™ã€‚ã“ã“ã«æŠ•è³‡ã«ã‚ˆã‚‹é‹ç”¨ã‚’åŠ ãˆã‚‹ã“ã¨ã§ã€ã•ã‚‰ã«åŠ¹ç‡çš„ãªè³‡ç”£å½¢æˆãŒæœŸå¾…ã§ãã¾ã™ã€‚</p>`;
                }
            }
            document.getElementById('alertBox').className = alertClass;
            document.getElementById('alertBox').innerHTML = alertHTML;

            // å¹³å‡å¹´é–“åæ”¯ã‚’è¨ˆç®—
            const totalCashflow = cashflowData.reduce((sum, d) => sum + d.annualCashflow, 0);
            const averageCashflow = totalCashflow / 60;
            
            // è¿”æ¸ˆè² æ‹…ç‡ã®è¨ˆç®—
            // è³¼å…¥åˆå¹´åº¦ï¼ˆãƒ­ãƒ¼ãƒ³é–‹å§‹å¹´ï¼‰ã®ä¸–å¸¯å¹´åã¨ãƒ­ãƒ¼ãƒ³å¹´é–“è¿”æ¸ˆé¡ã®ã¿ã§è¨ˆç®—
            const purchaseYearData = cashflowData[loanStartYear];
            let debtBurdenRatio = 0;
            if (purchaseYearData && purchaseYearData.totalIncome > 0) {
                // å¹´é–“ãƒ­ãƒ¼ãƒ³è¿”æ¸ˆé¡ã®ã¿ã‚’ä½¿ç”¨ï¼ˆé ­é‡‘ãƒ»åˆæœŸè²»ç”¨ã¯é™¤å¤–ï¼‰
                debtBurdenRatio = (annualLoan / purchaseYearData.totalIncome) * 100;
            }
            
            // å…¨æœŸé–“ã®å¹³å‡æ”¯å‡ºå¯¾åå…¥æ¯”ç‡
            const avgExpenseRatio = totalIncome > 0 ? (totalExpense / totalIncome) * 100 : 0;

            // ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰
            const summaryHTML = `
                <div class="summary-card">
                    <div class="summary-label">ç·åå…¥ï¼ˆ60å¹´ï¼‰</div>
                    <div class="summary-value">${formatMoney(totalIncome)}</div>
                </div>
                <div class="summary-card">
                    <div class="summary-label">ç·æ”¯å‡ºï¼ˆ60å¹´ï¼‰</div>
                    <div class="summary-value">${formatMoney(totalExpense)}</div>
                </div>
                <div class="summary-card">
                    <div class="summary-label">å¹³å‡å¹´é–“åæ”¯</div>
                    <div class="summary-value ${averageCashflow >= 0 ? 'good' : 'warning'}">
                        ${formatMoney(averageCashflow)}
                    </div>
                </div>
                <div class="summary-card">
                    <div class="summary-label">è¿”æ¸ˆè² æ‹…ç‡ï¼ˆè³¼å…¥æ™‚ï¼‰</div>
                    <div class="summary-value ${debtBurdenRatio <= 35 ? 'good' : debtBurdenRatio <= 40 ? 'warning' : 'bad'}">
                        ${debtBurdenRatio.toFixed(1)}%
                    </div>
                    <div style="font-size: 11px; color: #666; margin-top: 4px;">
                        ${debtBurdenRatio <= 35 ? 'âœ“ é©æ­£ç¯„å›²å†…' : debtBurdenRatio <= 40 ? 'âš  ã‚„ã‚„é«˜ã‚' : 'âš  è¦æ³¨æ„'}
                    </div>
                </div>
                <div class="summary-card">
                    <div class="summary-label">å¹³å‡æ”¯å‡ºæ¯”ç‡</div>
                    <div class="summary-value ${avgExpenseRatio <= 85 ? 'good' : 'warning'}">
                        ${avgExpenseRatio.toFixed(1)}%
                    </div>
                    <div style="font-size: 11px; color: #666; margin-top: 4px;">åå…¥ã®${avgExpenseRatio.toFixed(0)}%ãŒæ”¯å‡º</div>
                </div>
                <div class="summary-card">
                    <div class="summary-label">æœ€çµ‚è²¯è“„æ®‹é«˜</div>
                    <div class="summary-value ${finalSavings >= 1000 ? 'good' : 'warning'}">
                        ${formatMoney(finalSavings)}
                    </div>
                </div>
                <div class="summary-card">
                    <div class="summary-label">æœ€ä½è²¯è“„æ®‹é«˜</div>
                    <div class="summary-value ${minSavings >= 0 ? 'good' : 'warning'}">
                        ${formatMoney(minSavings)}
                    </div>
                </div>
                <div class="summary-card">
                    <div class="summary-label">å€Ÿå…¥é¡</div>
                    <div class="summary-value">${formatMoney(loanAmount)}</div>
                </div>
                <div class="summary-card">
                    <div class="summary-label">åˆå¹´åº¦è¿”æ¸ˆé¡</div>
                    <div class="summary-value">${formatMoney(annualLoan)}</div>
                </div>
            `;
            document.getElementById('summaryCards').innerHTML = summaryHTML;
            
            // ãƒªã‚¹ã‚¯ä¿¡å·æ©Ÿã¨ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã¯å‰Šé™¤æ¸ˆã¿
        }

        function updateRiskIndicator(minSavings, finalSavings) {
            const indicator = document.getElementById('riskIndicator');
            const icon = document.getElementById('riskIcon');
            const title = document.getElementById('riskTitle');
            const description = document.getElementById('riskDescription');
            
            // ã‚¯ãƒ©ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ
            indicator.className = 'risk-indicator';

            if (minSavings < 0) {
                indicator.classList.add('risk-high');
                icon.textContent = 'âš ï¸';
                title.textContent = 'ãƒªã‚¹ã‚¯é«˜';
                title.style.color = '#ff5757';
                description.textContent = 'å°†æ¥çš„ã«è²¯è“„ãŒãƒã‚¤ãƒŠã‚¹ã«ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚åæ”¯ã®è¦‹ç›´ã—ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚';
            } else if (finalSavings < 1000) {
                indicator.classList.add('risk-medium');
                icon.textContent = 'âš¡';
                title.textContent = 'è¦æ³¨æ„';
                title.style.color = '#ffc107';
                description.textContent = 'è€å¾Œè³‡é‡‘ãŒä¸è¶³æ°—å‘³ã§ã™ã€‚è²¯è“„ã‚„æŠ•è³‡ã®ç©ã¿å¢—ã—ã‚’æ¤œè¨ã—ã¾ã—ã‚‡ã†ã€‚';
            } else {
                indicator.classList.add('risk-low');
                icon.textContent = 'âœ…';
                title.textContent = 'è‰¯å¥½';
                title.style.color = '#28a745';
                description.textContent = 'å®‰å®šã—ãŸå®¶è¨ˆé‹å–¶ãŒã§ãã¦ã„ã¾ã™ã€‚ã“ã®èª¿å­ã§è¨ˆç”»çš„ãªè²¯è“„ã‚’ç¶™ç¶šã—ã¾ã—ã‚‡ã†ã€‚';
            }

            indicator.style.display = 'block';
        }

        function updateTimeline(startAge, loanStart, loanTerm, child1, child2, child3) {
            const events = [];
            
            // ä½å®…è³¼å…¥
            if (loanStart > 0) {
                events.push({
                    year: loanStart,
                    label: 'ğŸ <br>ä½å®…è³¼å…¥',
                    age: startAge + loanStart
                });
            }
            
            // ãƒ­ãƒ¼ãƒ³å®Œæ¸ˆ
            events.push({
                year: loanStart + loanTerm,
                label: 'âœ¨<br>ãƒ­ãƒ¼ãƒ³å®Œæ¸ˆ',
                age: startAge + loanStart + loanTerm
            });
            
            // å­ã©ã‚‚ã®å¤§å­¦å…¥å­¦
            if (child1 !== 0 && child1 < 30) {
                const year = 18 - child1;
                if (year >= 0 && year <= 60) {
                    events.push({
                        year: year,
                        label: 'ğŸ“<br>ç¬¬ä¸€å­<br>å¤§å­¦å…¥å­¦',
                        age: startAge + year
                    });
                }
            }
            if (child2 !== 0 && child2 < 30) {
                const year = 18 - child2;
                if (year >= 0 && year <= 60) {
                    events.push({
                        year: year,
                        label: 'ğŸ“<br>ç¬¬äºŒå­<br>å¤§å­¦å…¥å­¦',
                        age: startAge + year
                    });
                }
            }
            if (child3 !== 0 && child3 < 30) {
                const year = 18 - child3;
                if (year >= 0 && year <= 60) {
                    events.push({
                        year: year,
                        label: 'ğŸ“<br>ç¬¬ä¸‰å­<br>å¤§å­¦å…¥å­¦',
                        age: startAge + year
                    });
                }
            }
            
            // å®šå¹´é€€è·
            const retireYear = 65 - startAge;
            if (retireYear >= 0 && retireYear <= 60) {
                events.push({
                    year: retireYear,
                    label: 'ğŸ‘”<br>å®šå¹´é€€è·',
                    age: 65
                });
            }
            
            // å¹´é½¢é †ã«ã‚½ãƒ¼ãƒˆ
            events.sort((a, b) => a.year - b.year);
            
            // é‡è¤‡ã‚’é™¤å»ï¼ˆåŒã˜å¹´ã®ã‚¤ãƒ™ãƒ³ãƒˆï¼‰
            const uniqueEvents = [];
            let lastYear = -1;
            events.forEach(e => {
                if (e.year !== lastYear && e.year >= 0 && e.year <= 60) {
                    uniqueEvents.push(e);
                    lastYear = e.year;
                }
            });

            // HTMLç”Ÿæˆ
            let html = '';
            uniqueEvents.forEach(e => {
                html += `
                    <div class="timeline-event">
                        <div class="timeline-marker"></div>
                        <div class="timeline-label">
                            ${e.label}<br>
                            <span class="timeline-year">${e.year}å¹´ç›® (${e.age}æ­³)</span>
                        </div>
                    </div>
                `;
            });

            document.getElementById('timelineEvents').innerHTML = html;
            document.getElementById('timelineContainer').style.display = 'block';
        }

        function updateCharts(loanSchedule) {
            // æ¦‚è¦ãƒãƒ£ãƒ¼ãƒˆ
            if (charts.overview) charts.overview.destroy();
            const overviewCtx = document.getElementById('overviewChart').getContext('2d');
            charts.overview = new Chart(overviewCtx, {
                type: 'line',
                data: {
                    labels: cashflowData.map((d, i) => i + 1 + 'å¹´'),
                    datasets: [{
                        label: 'å¹´é–“åæ”¯',
                        data: cashflowData.map(d => d.annualCashflow),
                        borderColor: '#ff5757',
                        backgroundColor: 'rgba(255, 87, 87, 0.15)',
                        borderWidth: 3,
                        pointRadius: 0,
                        pointHoverRadius: 6,
                        yAxisID: 'y',
                        tension: 0.4
                    }, {
                        label: 'ç·è³‡ç”£ï¼ˆè²¯è“„+æŠ•è³‡ï¼‰',
                        data: cashflowData.map(d => d.totalAssets),
                        segment: {
                            borderColor: function(ctx) {
                                const yVal = ctx.p1.parsed.y;
                                return yVal < 0 ? '#dc3545' : '#28a745';
                            },
                            backgroundColor: function(ctx) {
                                const yVal = ctx.p1.parsed.y;
                                return yVal < 0 ? 'rgba(220, 53, 69, 0.15)' : 'rgba(40, 167, 69, 0.15)';
                            }
                        },
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.15)',
                        borderWidth: 3,
                        pointRadius: 0,
                        pointHoverRadius: 6,
                        pointBackgroundColor: function(ctx) {
                            const val = cashflowData[ctx.dataIndex]?.totalAssets;
                            return val < 0 ? '#dc3545' : '#28a745';
                        },
                        yAxisID: 'y1',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                font: { size: 14, weight: '600' },
                                padding: 15,
                                usePointStyle: true,
                                generateLabels: function(chart) {
                                    const labels = Chart.defaults.plugins.legend.labels.generateLabels(chart);
                                    // ç·è³‡ç”£ãŒãƒã‚¤ãƒŠã‚¹ã«ãªã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°å‡¡ä¾‹ã«ã‚‚èµ¤ã‚’è¿½åŠ 
                                    const hasNegative = cashflowData.some(d => d.totalAssets < 0);
                                    if (hasNegative) {
                                        labels.push({
                                            text: 'è³‡é‡‘ã‚·ãƒ§ãƒ¼ãƒˆåŒºé–“',
                                            fillStyle: 'rgba(220, 53, 69, 0.15)',
                                            strokeStyle: '#dc3545',
                                            lineWidth: 3,
                                            pointStyle: 'line',
                                            hidden: false
                                        });
                                    }
                                    return labels;
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleFont: { size: 14, weight: '600' },
                            bodyFont: { size: 13 },
                            cornerRadius: 8
                        }
                    },
                    scales: {
                        x: { 
                            ticks: { 
                                maxTicksLimit: 20,
                                font: { size: 12 }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        y: { 
                            type: 'linear', 
                            position: 'left', 
                            title: { 
                                display: true, 
                                text: 'å¹´é–“åæ”¯ï¼ˆä¸‡å††ï¼‰',
                                font: { size: 14, weight: '600' }
                            },
                            ticks: {
                                font: { size: 12 },
                                callback: function(value) {
                                    return value.toLocaleString() + 'ä¸‡';
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.08)'
                            }
                        },
                        y1: { 
                            type: 'linear', 
                            position: 'right', 
                            title: { 
                                display: true, 
                                text: 'ç·è³‡ç”£ï¼ˆä¸‡å††ï¼‰',
                                font: { size: 14, weight: '600' }
                            },
                            ticks: {
                                font: { size: 12 },
                                callback: function(value) {
                                    return value.toLocaleString() + 'ä¸‡';
                                }
                            },
                            grid: { 
                                drawOnChartArea: false 
                            }
                        }
                    }
                }
            });

            // åå…¥ãƒãƒ£ãƒ¼ãƒˆ
            if (charts.income) charts.income.destroy();
            const incomeCtx = document.getElementById('incomeChart').getContext('2d');
            charts.income = new Chart(incomeCtx, {
                type: 'bar',
                data: {
                    labels: cashflowData.map((d, i) => i + 1 + 'å¹´'),
                    datasets: [{
                        label: 'æœ¬äººåå…¥',
                        data: cashflowData.map(d => d.income1),
                        backgroundColor: '#ff5757'
                    }, {
                        label: 'é…å¶è€…åå…¥',
                        data: cashflowData.map(d => d.income2),
                        backgroundColor: '#2c5f8a'
                    }, {
                        label: 'é€€è·é‡‘',
                        data: cashflowData.map(d => d.retirement),
                        backgroundColor: '#e67e22'
                    }, {
                        label: 'å…ç«¥æ‰‹å½“',
                        data: cashflowData.map(d => d.childAllowance),
                        backgroundColor: '#27ae60'
                    }, {
                        label: 'ãƒ­ãƒ¼ãƒ³æ§é™¤ãƒ»å„ªé‡',
                        data: cashflowData.map(d => d.deduction + d.longTermBonus),
                        backgroundColor: '#8e44ad'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { font: { size: 12, weight: '600' }, padding: 10 }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const val = context.parsed.y;
                                    if (val === 0) return null;
                                    return context.dataset.label + ': ' + Math.round(val).toLocaleString() + 'ä¸‡å††';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            stacked: true,
                            ticks: { maxTicksLimit: 20, font: { size: 11 } },
                            grid: { color: 'rgba(0, 0, 0, 0.05)' }
                        },
                        y: {
                            stacked: true,
                            ticks: {
                                font: { size: 11 },
                                callback: function(value) {
                                    return value.toLocaleString() + 'ä¸‡';
                                }
                            },
                            grid: { color: 'rgba(0, 0, 0, 0.08)' }
                        }
                    }
                }
            });

            // æ”¯å‡ºãƒãƒ£ãƒ¼ãƒˆ
            if (charts.expense) charts.expense.destroy();
            const expenseCtx = document.getElementById('expenseChart').getContext('2d');
            charts.expense = new Chart(expenseCtx, {
                type: 'bar',
                data: {
                    labels: cashflowData.map((d, i) => i + 1 + 'å¹´'),
                    datasets: [{
                        label: 'ç”Ÿæ´»è²»',
                        data: cashflowData.map(d => d.livingCost),
                        backgroundColor: '#ff5757'
                    }, {
                        label: 'ä½å±…è²»',
                        data: cashflowData.map(d => d.housingCost),
                        backgroundColor: '#2c5f8a'
                    }, {
                        label: 'æ•™è‚²è²»',
                        data: cashflowData.map(d => d.educationCost),
                        backgroundColor: '#ffc107'
                    }, {
                        label: 'è»Šãƒ»é€šä¿¡ãƒ»å°é£ã„',
                        data: cashflowData.map(d => d.carCost + d.communication + d.allowance),
                        backgroundColor: '#8e44ad'
                    }, {
                        label: 'ä¿é™ºãƒ»ä»‹è­·',
                        data: cashflowData.map(d => d.lifeInsurance + d.propertyInsurance + d.careCost),
                        backgroundColor: '#27ae60'
                    }, {
                        label: 'ãã®ä»–ãƒ­ãƒ¼ãƒ³',
                        data: cashflowData.map(d => d.otherLoan),
                        backgroundColor: '#e67e22'
                    }, {
                        label: 'ç©ç«‹æŠ•è³‡',
                        data: cashflowData.map(d => d.investmentContribution),
                        backgroundColor: '#3498db'
                    }, {
                        label: 'ç«ç½ä¿é™ºãƒ»è‡¨æ™‚æ”¯å‡º',
                        data: cashflowData.map(d => d.fireInsurance + d.temporaryExpense),
                        backgroundColor: '#95a5a6'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { font: { size: 12, weight: '600' }, padding: 10 }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const val = context.parsed.y;
                                    if (val === 0) return null;
                                    return context.dataset.label + ': ' + Math.round(val).toLocaleString() + 'ä¸‡å††';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            stacked: true,
                            ticks: { maxTicksLimit: 20, font: { size: 11 } },
                            grid: { color: 'rgba(0, 0, 0, 0.05)' }
                        },
                        y: {
                            stacked: true,
                            ticks: {
                                font: { size: 11 },
                                callback: function(value) {
                                    return value.toLocaleString() + 'ä¸‡';
                                }
                            },
                            grid: { color: 'rgba(0, 0, 0, 0.08)' }
                        }
                    }
                }
            });

            // è²¯è“„ãƒãƒ£ãƒ¼ãƒˆ
            if (charts.savings) charts.savings.destroy();
            const savingsCtx = document.getElementById('savingsChart').getContext('2d');
            charts.savings = new Chart(savingsCtx, {
                type: 'line',
                data: {
                    labels: cashflowData.map((d, i) => i + 1 + 'å¹´'),
                    datasets: [{
                        label: 'è²¯è“„æ®‹é«˜',
                        data: cashflowData.map(d => d.savings),
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.2)',
                        borderWidth: 3,
                        pointRadius: 0,
                        pointHoverRadius: 6,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { font: { size: 13, weight: '600' }, padding: 12 }
                        }
                    },
                    scales: { 
                        x: { 
                            ticks: { maxTicksLimit: 20, font: { size: 11 } },
                            grid: { color: 'rgba(0, 0, 0, 0.05)' }
                        },
                        y: {
                            ticks: { 
                                font: { size: 11 },
                                callback: function(value) {
                                    return value.toLocaleString() + 'ä¸‡';
                                }
                            },
                            grid: { color: 'rgba(0, 0, 0, 0.08)' }
                        }
                    }
                }
            });

            // ãƒ­ãƒ¼ãƒ³ãƒãƒ£ãƒ¼ãƒˆ
            if (charts.loan) charts.loan.destroy();
            const loanCtx = document.getElementById('loanChart').getContext('2d');
            charts.loan = new Chart(loanCtx, {
                type: 'bar',
                data: {
                    labels: loanSchedule.map(d => d.year + 'å¹´'),
                    datasets: [{
                        label: 'å…ƒé‡‘',
                        data: loanSchedule.map(d => d.principal),
                        backgroundColor: '#1a3a5c'
                    }, {
                        label: 'åˆ©æ¯',
                        data: loanSchedule.map(d => d.interest),
                        backgroundColor: '#ffc107'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { font: { size: 13, weight: '600' }, padding: 12 }
                        }
                    },
                    scales: {
                        x: { 
                            stacked: true,
                            ticks: { font: { size: 11 } },
                            grid: { color: 'rgba(0, 0, 0, 0.05)' }
                        },
                        y: { 
                            stacked: true,
                            ticks: { font: { size: 11 } },
                            grid: { color: 'rgba(0, 0, 0, 0.08)' }
                        }
                    }
                }
            });
        }

        function updateTable() {
            const table = document.getElementById('cashflowTable');
            let html = `
                <thead>
                    <tr>
                        <th class="year-column" rowspan="2">å¹´</th>
                        <th rowspan="2">æœ¬äºº<br>å¹´é½¢</th>
                        <th rowspan="2">é…å¶è€…<br>å¹´é½¢</th>
                        <th colspan="4" style="background: #e74c3c; border-bottom: 2px solid #ff5757;">åå…¥å†…è¨³</th>
                        <th rowspan="2" style="background: #a93226;">ç·åå…¥</th>
                        <th colspan="5" style="background: #2c5f8a; border-bottom: 2px solid #3498db;">æ”¯å‡ºå†…è¨³</th>
                        <th rowspan="2" style="background: #1a3a5c;">ç·æ”¯å‡º</th>
                        <th rowspan="2">å¹´é–“<br>åæ”¯</th>
                        <th rowspan="2">è²¯è“„<br>æ®‹é«˜</th>
                        <th rowspan="2">æŠ•è³‡<br>è©•ä¾¡é¡</th>
                        <th rowspan="2">ç·è³‡ç”£</th>
                    </tr>
                    <tr>
                        <th style="background: #c0392b; font-size:11px;">æœ¬äºº</th>
                        <th style="background: #c0392b; font-size:11px;">é…å¶è€…</th>
                        <th style="background: #c0392b; font-size:11px;">é€€è·é‡‘<br>æ‰‹å½“ç­‰</th>
                        <th style="background: #c0392b; font-size:11px;">å…ç«¥<br>æ‰‹å½“</th>
                        <th style="background: #2c5f8a; font-size:11px;">ç”Ÿæ´»è²»</th>
                        <th style="background: #2c5f8a; font-size:11px;">ä½å±…è²»</th>
                        <th style="background: #2c5f8a; font-size:11px;">æ•™è‚²è²»</th>
                        <th style="background: #2c5f8a; font-size:11px;">ä¿é™º<br>è»Šç­‰</th>
                        <th style="background: #2c5f8a; font-size:11px;">ç©ç«‹<br>æŠ•è³‡ç­‰</th>
                    </tr>
                </thead>
                <tbody>
            `;
            cashflowData.forEach((d, i) => {
                const otherIncome = d.retirement + d.deduction + d.longTermBonus;
                const insuranceCarEtc = d.carCost + d.communication + d.allowance + d.lifeInsurance + d.propertyInsurance + d.otherLoan + d.careCost;
                const investEtc = d.investmentContribution + d.fireInsurance + d.temporaryExpense;
                html += `
                    <tr>
                        <td class="year-column">${i + 1}å¹´ç›®</td>
                        <td>${d.age1}æ­³</td>
                        <td>${d.age2 > 0 ? d.age2 + 'æ­³' : '-'}</td>
                        <td style="color:#c0392b;">${formatMoney(d.income1)}</td>
                        <td style="color:#c0392b;">${formatMoney(d.income2)}</td>
                        <td style="color:#c0392b;">${otherIncome > 0 ? formatMoney(otherIncome) : '-'}</td>
                        <td style="color:#c0392b;">${d.childAllowance > 0 ? formatMoney(d.childAllowance) : '-'}</td>
                        <td style="color:#c0392b; font-weight:600; background:rgba(255,87,87,0.05);">${formatMoney(d.totalIncome)}</td>
                        <td style="color:#2c5f8a;">${formatMoney(d.livingCost)}</td>
                        <td style="color:#2c5f8a;">${formatMoney(d.housingCost)}</td>
                        <td style="color:#2c5f8a;">${d.educationCost > 0 ? formatMoney(d.educationCost) : '-'}</td>
                        <td style="color:#2c5f8a;">${insuranceCarEtc > 0 ? formatMoney(insuranceCarEtc) : '-'}</td>
                        <td style="color:#2c5f8a;">${investEtc > 0 ? formatMoney(investEtc) : '-'}</td>
                        <td style="color:#2c5f8a; font-weight:600; background:rgba(44,95,138,0.05);">${formatMoney(d.totalExpense)}</td>
                        <td style="color: ${d.annualCashflow >= 0 ? '#28a745' : '#dc3545'}; font-weight:600;">${formatMoney(d.annualCashflow)}</td>
                        <td style="color: ${d.savings >= 0 ? '#28a745' : '#dc3545'}; font-weight: 600">${formatMoney(d.savings)}</td>
                        <td style="color: #1976d2; font-weight: 600">${formatMoney(d.investment)}</td>
                        <td style="color: ${d.totalAssets >= 0 ? '#28a745' : '#dc3545'}; font-weight: 700">${formatMoney(d.totalAssets)}</td>
                    </tr>
                `;
            });
            html += '</tbody>';
            table.innerHTML = html;
        }

        function switchTab(event, tabName) {
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            const contents = document.querySelectorAll('.tab-content');
            contents.forEach(content => content.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
        }

        function formatMoney(value) {
            return Math.round(value).toLocaleString('ja-JP') + 'ä¸‡å††';
        }

        function downloadCSV() {
            const headers = ['å¹´', 'æœ¬äººå¹´é½¢', 'é…å¶è€…å¹´é½¢', 'å­1å¹´é½¢', 'å­2å¹´é½¢', 'å­3å¹´é½¢',
                           'æœ¬äººåå…¥', 'é…å¶è€…åå…¥', 'é€€è·é‡‘', 'å…ç«¥æ‰‹å½“', 'ãƒ­ãƒ¼ãƒ³æ§é™¤', 'é•·æœŸå„ªè‰¯å„ªé‡', 'ç·åå…¥',
                           'ç”Ÿæ´»è²»', 'ä½å±…è²»', 'è»Šé–¢é€£è²»', 'é€šä¿¡è²»', 'ãŠå°é£ã„', 'æ•™è‚²è²»',
                           'ç”Ÿå‘½ä¿é™º', 'æå®³ä¿é™º', 'ãã®ä»–ãƒ­ãƒ¼ãƒ³', 'ä»‹è­·è²»',
                           'ç©ç«‹æŠ•è³‡', 'ç«ç½ä¿é™º', 'è‡¨æ™‚æ”¯å‡º', 'ç·æ”¯å‡º',
                           'å¹´é–“åæ”¯', 'è²¯è“„æ®‹é«˜', 'æŠ•è³‡è©•ä¾¡é¡', 'ç·è³‡ç”£'];

            const rows = cashflowData.map((d, i) => [
                i + 1, d.age1, d.age2 > 0 ? d.age2 : '',
                d.ageChild1, d.ageChild2, d.ageChild3,
                Math.round(d.income1), Math.round(d.income2), Math.round(d.retirement),
                Math.round(d.childAllowance), Math.round(d.deduction), Math.round(d.longTermBonus),
                Math.round(d.totalIncome),
                Math.round(d.livingCost), Math.round(d.housingCost), Math.round(d.carCost),
                Math.round(d.communication), Math.round(d.allowance), Math.round(d.educationCost),
                Math.round(d.lifeInsurance), Math.round(d.propertyInsurance), Math.round(d.otherLoan),
                Math.round(d.careCost),
                Math.round(d.investmentContribution), Math.round(d.fireInsurance), Math.round(d.temporaryExpense),
                Math.round(d.totalExpense),
                Math.round(d.annualCashflow), Math.round(d.savings),
                Math.round(d.investment), Math.round(d.totalAssets)
            ]);

            const csv = Papa.unparse({ fields: headers, data: rows });
            const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'cashflow_' + new Date().getTime() + '.csv';
            link.click();
        }

        // æ¯”è¼ƒãƒ¢ãƒ¼ãƒ‰è¨ˆç®—
        function calculateWithComparison() {
            const propertyPrice = parseFloat(document.getElementById('propertyPrice').value);
            const downPayment = parseFloat(document.getElementById('downPayment').value);
            const loanAmount = propertyPrice - downPayment;
            const loanTerm = parseInt(document.getElementById('loanTermCompare').value);
            
            const fixedRate = parseFloat(document.getElementById('fixedRate').value) / 100;
            const variableRate = parseFloat(document.getElementById('variableRate').value) / 100;
            const scenario = document.getElementById('rateScenario').value;
            
            // ã‚·ãƒŠãƒªã‚ªã”ã¨ã®é‡‘åˆ©ä¸Šæ˜‡ç‡ã‚’è¨­å®š
            const rateIncreaseMap = {
                optimistic: 0.0002,   // å¹´é–“+0.02%
                standard: 0.0005,     // å¹´é–“+0.05%
                pessimistic: 0.0015   // å¹´é–“+0.15%
            };
            const rateIncrease = rateIncreaseMap[scenario];

            // å›ºå®šé‡‘åˆ©è¨ˆç®—
            const fixedResult = calculateLoanSchedule(loanAmount, fixedRate, loanTerm);
            
            // å¤‰å‹•é‡‘åˆ©è¨ˆç®—
            const variableResult = calculateVariableLoan(loanAmount, variableRate, rateIncrease, loanTerm);
            
            // æ¯”è¼ƒçµæœè¡¨ç¤º
            displayComparisonResults(fixedResult, variableResult, scenario);
            
            // é€šå¸¸ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚‚å®Ÿè¡Œï¼ˆå›ºå®šé‡‘åˆ©ãƒ™ãƒ¼ã‚¹ï¼‰
            document.getElementById('interestRate').value = (fixedRate * 100).toFixed(1);
            document.getElementById('loanTerm').value = loanTerm;
            calculateNormal();
        }

        function calculateLoanSchedule(principal, rate, term) {
            const monthlyRate = rate / 12;
            const numPayments = term * 12;
            let monthlyPayment = 0;
            
            if (rate === 0) {
                monthlyPayment = principal / numPayments;
            } else {
                monthlyPayment = principal * (monthlyRate * Math.pow(1 + monthlyRate, numPayments)) / 
                                (Math.pow(1 + monthlyRate, numPayments) - 1);
            }

            const schedule = [];
            let balance = principal;
            let totalInterest = 0;

            for (let year = 1; year <= term; year++) {
                let yearPrincipal = 0;
                let yearInterest = 0;
                
                for (let month = 1; month <= 12; month++) {
                    const interest = balance * monthlyRate;
                    const principalPmt = monthlyPayment - interest;
                    balance -= principalPmt;
                    if (balance < 0) balance = 0;
                    
                    totalInterest += interest;
                    yearPrincipal += principalPmt;
                    yearInterest += interest;
                }
                
                schedule.push({
                    year: year,
                    payment: monthlyPayment * 12,
                    principal: yearPrincipal,
                    interest: yearInterest,
                    balance: balance
                });
            }

            return {
                schedule: schedule,
                totalPayment: principal + totalInterest,
                totalInterest: totalInterest,
                monthlyPayment: monthlyPayment
            };
        }

        function calculateVariableLoan(principal, initialRate, rateIncrease, term) {
            const schedule = [];
            let balance = principal;
            let totalInterest = 0;
            let currentRate = initialRate;
            const maxRate = 0.03; // ä¸Šé™3%ï¼ˆç¾å®Ÿçš„ãªç¯„å›²ï¼‰

            for (let year = 1; year <= term; year++) {
                const monthlyRate = currentRate / 12;
                const remainingMonths = (term - year + 1) * 12;
                
                let monthlyPayment;
                if (currentRate === 0) {
                    monthlyPayment = balance / remainingMonths;
                } else {
                    monthlyPayment = balance * (monthlyRate * Math.pow(1 + monthlyRate, remainingMonths)) / 
                                    (Math.pow(1 + monthlyRate, remainingMonths) - 1);
                }

                let yearPrincipal = 0;
                let yearInterest = 0;

                for (let month = 1; month <= 12; month++) {
                    const interest = balance * monthlyRate;
                    const principalPmt = monthlyPayment - interest;
                    balance -= principalPmt;
                    if (balance < 0) balance = 0;
                    
                    totalInterest += interest;
                    yearPrincipal += principalPmt;
                    yearInterest += interest;
                }

                schedule.push({
                    year: year,
                    payment: monthlyPayment * 12,
                    principal: yearPrincipal,
                    interest: yearInterest,
                    balance: balance,
                    rate: currentRate * 100
                });

                // é‡‘åˆ©ã‚’ä¸Šæ˜‡ã•ã›ã‚‹ï¼ˆä¸Šé™ã‚ã‚Šï¼‰
                currentRate += rateIncrease;
                if (currentRate > maxRate) currentRate = maxRate;
            }

            return {
                schedule: schedule,
                totalPayment: principal + totalInterest,
                totalInterest: totalInterest,
                monthlyPayment: schedule[0].payment / 12,
                finalRate: currentRate * 100
            };
        }

        function displayComparisonResults(fixed, variable, scenario) {
            const difference = variable.totalInterest - fixed.totalInterest;
            const isFixedBetter = difference > 0;
            
            const scenarioNames = {
                optimistic: 'æ¥½è¦³ã‚·ãƒŠãƒªã‚ª',
                standard: 'æ¨™æº–ã‚·ãƒŠãƒªã‚ª',
                pessimistic: 'æ‚²è¦³ã‚·ãƒŠãƒªã‚ª'
            };

            const compHTML = `
                <div class="chart-container">
                    <div class="chart-title">ğŸ”„ å¤‰å‹•é‡‘åˆ© vs å›ºå®šé‡‘åˆ© æ¯”è¼ƒçµæœ</div>
                    <div style="text-align: center; margin-bottom: 20px; padding: 15px; background: #e3f2fd; border-radius: 10px;">
                        <p style="font-size: 16px; color: #333; font-weight: 600;">
                            ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ¡ä»¶ï¼š<strong>${scenarioNames[scenario]}</strong>
                        </p>
                        <p style="font-size: 14px; color: #666; margin-top: 5px;">
                            å¤‰å‹•é‡‘åˆ©ã¯ ${variable.schedule[0].rate.toFixed(2)}% â†’ ${variable.finalRate.toFixed(2)}% ã¾ã§æ¨ç§»
                        </p>
                    </div>
                    <div class="comparison-container">
                        <div class="comparison-section ${isFixedBetter ? 'winner' : ''}">
                            <div class="comparison-title">
                                ${isFixedBetter ? '<div class="winner-badge">âœ… ã‚ˆã‚Šæœ‰åˆ©</div>' : ''}
                                å›ºå®šé‡‘åˆ©
                            </div>
                            <div class="summary-cards">
                                <div class="summary-card">
                                    <div class="summary-label">æœˆé¡è¿”æ¸ˆï¼ˆå¤‰å‹•ãªã—ï¼‰</div>
                                    <div class="summary-value">${formatMoney(fixed.monthlyPayment)}</div>
                                </div>
                                <div class="summary-card">
                                    <div class="summary-label">ç·è¿”æ¸ˆé¡</div>
                                    <div class="summary-value">${formatMoney(fixed.totalPayment)}</div>
                                </div>
                                <div class="summary-card">
                                    <div class="summary-label">åˆ©æ¯ç·é¡</div>
                                    <div class="summary-value">${formatMoney(fixed.totalInterest)}</div>
                                </div>
                            </div>
                        </div>
                        <div class="comparison-section ${!isFixedBetter ? 'winner' : ''}">
                            <div class="comparison-title">
                                ${!isFixedBetter ? '<div class="winner-badge">âœ… ã‚ˆã‚Šæœ‰åˆ©</div>' : ''}
                                å¤‰å‹•é‡‘åˆ©
                            </div>
                            <div class="summary-cards">
                                <div class="summary-card">
                                    <div class="summary-label">åˆå›æœˆé¡è¿”æ¸ˆ</div>
                                    <div class="summary-value">${formatMoney(variable.monthlyPayment)}</div>
                                </div>
                                <div class="summary-card">
                                    <div class="summary-label">ç·è¿”æ¸ˆé¡</div>
                                    <div class="summary-value">${formatMoney(variable.totalPayment)}</div>
                                </div>
                                <div class="summary-card">
                                    <div class="summary-label">åˆ©æ¯ç·é¡</div>
                                    <div class="summary-value">${formatMoney(variable.totalInterest)}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="comparison-result">
                        <h3 style="margin-bottom: 15px; color: #333;">ğŸ’° å·®é¡</h3>
                        <p style="font-size: 18px; color: ${isFixedBetter ? '#28a745' : '#ff5757'}; font-weight: 700; margin-bottom: 10px;">
                            ${isFixedBetter ? 'å›ºå®šé‡‘åˆ©' : 'å¤‰å‹•é‡‘åˆ©'}ã®æ–¹ãŒ <strong>${formatMoney(Math.abs(difference))}</strong> ãŠå¾—
                        </p>
                        <p style="color: #666; font-size: 14px;">
                            â€» ${scenarioNames[scenario]}ã‚’æƒ³å®šã—ãŸã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ã™ã€‚å®Ÿéš›ã®é‡‘åˆ©å¤‰å‹•ã¯çµŒæ¸ˆçŠ¶æ³ã«ã‚ˆã‚Šç•°ãªã‚Šã¾ã™ã€‚
                        </p>
                    </div>
                </div>
                <div class="chart-container">
                    <div class="chart-title">å¹´é–“è¿”æ¸ˆé¡ã®æ¨ç§»</div>
                    <div class="chart-wrapper">
                        <canvas id="comparisonPaymentChart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <div class="chart-title">é‡‘åˆ©ã®æ¨ç§»ï¼ˆå¤‰å‹•é‡‘åˆ© - ${scenarioNames[scenario]}ï¼‰</div>
                    <div class="chart-wrapper">
                        <canvas id="comparisonRateChart"></canvas>
                    </div>
                </div>
            `;

            document.getElementById('comparisonContent').innerHTML = compHTML;
            document.getElementById('comparisonTab').style.display = 'block';

            // ã‚°ãƒ©ãƒ•æç”»
            setTimeout(() => {
                // è¿”æ¸ˆé¡æ¯”è¼ƒã‚°ãƒ©ãƒ•
                if (charts.compPayment) charts.compPayment.destroy();
                const ctx1 = document.getElementById('comparisonPaymentChart').getContext('2d');
                charts.compPayment = new Chart(ctx1, {
                    type: 'line',
                    data: {
                        labels: fixed.schedule.map(d => d.year + 'å¹´'),
                        datasets: [{
                            label: 'å›ºå®šé‡‘åˆ©',
                            data: fixed.schedule.map(d => d.payment),
                            borderColor: '#ff5757',
                            backgroundColor: 'rgba(255, 87, 87, 0.1)',
                            tension: 0.3
                        }, {
                            label: 'å¤‰å‹•é‡‘åˆ©',
                            data: variable.schedule.map(d => d.payment),
                            borderColor: '#28a745',
                            backgroundColor: 'rgba(40, 167, 69, 0.1)',
                            tension: 0.3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'bottom' } }
                    }
                });

                // é‡‘åˆ©æ¨ç§»ã‚°ãƒ©ãƒ•
                if (charts.compRate) charts.compRate.destroy();
                const ctx2 = document.getElementById('comparisonRateChart').getContext('2d');
                charts.compRate = new Chart(ctx2, {
                    type: 'line',
                    data: {
                        labels: variable.schedule.map(d => d.year + 'å¹´'),
                        datasets: [{
                            label: 'å¤‰å‹•é‡‘åˆ©',
                            data: variable.schedule.map(d => d.rate),
                            borderColor: '#ff5757',
                            backgroundColor: 'rgba(255, 87, 87, 0.2)',
                            fill: true,
                            tension: 0.3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'bottom' } },
                        scales: {
                            y: {
                                title: { display: true, text: 'é‡‘åˆ©ï¼ˆ%ï¼‰' }
                            }
                        }
                    }
                });
            }, 100);
        }

        // åˆæœŸåŒ–
        window.addEventListener('load', function() {
            // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼åˆæœŸå€¤è¡¨ç¤º
            updateSlider('person1Age');
            updateSlider('person2Age');
            updateSlider('totalIncome');
            updateSlider('numChildren');
            updateSlider('propertyPrice');
            updateSlider('downPayment');
            
            // ç‰©ä»¶ä¾¡æ ¼ã®å†…è¨³ã‚’åˆæœŸåŒ–
            updateTotalPrice();

            // å­ã©ã‚‚ã®çŠ¶æ…‹ã‚’åˆæœŸåŒ–ï¼ˆå¹´é½¢ã«å¿œã˜ãŸç”£ä¼‘è¡¨ç¤ºåˆ‡æ›¿ï¼‰
            for (let i = 1; i <= 3; i++) {
                updateChildStatus(i);
                toggleChildSection(i);
            }

            // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰è¨­å®šã‚’èª­ã¿è¾¼ã¿
            loadFromURL();
        });

        // URLå…±æœ‰æ©Ÿèƒ½
        function openShareModal() {
            const params = new URLSearchParams();
            
            // åŸºæœ¬è¨­å®š
            params.set('p1age', document.getElementById('person1Age').value);
            params.set('p2age', document.getElementById('person2Age').value);
            params.set('income', document.getElementById('totalIncome').value);
            params.set('children', document.getElementById('numChildren').value);
            params.set('price', document.getElementById('propertyPrice').value);
            params.set('down', document.getElementById('downPayment').value);
            
            // æ¯”è¼ƒãƒ¢ãƒ¼ãƒ‰
            if (document.getElementById('compareRates').checked) {
                params.set('compare', '1');
                params.set('scenario', document.getElementById('rateScenario').value);
                params.set('fixed', document.getElementById('fixedRate').value);
                params.set('variable', document.getElementById('variableRate').value);
            }
            
            const url = window.location.origin + window.location.pathname + '?' + params.toString();
            document.getElementById('shareURL').value = url;
            document.getElementById('shareModal').style.display = 'block';
        }

        function closeShareModal() {
            document.getElementById('shareModal').style.display = 'none';
            document.getElementById('copySuccess').classList.remove('show');
        }

        function copyShareURL() {
            const urlInput = document.getElementById('shareURL');
            urlInput.select();
            urlInput.setSelectionRange(0, 99999); // ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ
            
            try {
                document.execCommand('copy');
                document.getElementById('copySuccess').classList.add('show');
                setTimeout(() => {
                    document.getElementById('copySuccess').classList.remove('show');
                }, 3000);
            } catch (err) {
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šClipboard API
                navigator.clipboard.writeText(urlInput.value).then(() => {
                    document.getElementById('copySuccess').classList.add('show');
                    setTimeout(() => {
                        document.getElementById('copySuccess').classList.remove('show');
                    }, 3000);
                });
            }
        }

        function loadFromURL() {
            const params = new URLSearchParams(window.location.search);
            
            if (params.has('p1age')) {
                document.getElementById('person1Age').value = params.get('p1age');
                updateSlider('person1Age');
            }
            if (params.has('p2age')) {
                document.getElementById('person2Age').value = params.get('p2age');
                updateSlider('person2Age');
            }
            if (params.has('income')) {
                document.getElementById('totalIncome').value = params.get('income');
                updateSlider('totalIncome');
            }
            if (params.has('children')) {
                document.getElementById('numChildren').value = params.get('children');
                updateSlider('numChildren');
            }
            if (params.has('price')) {
                document.getElementById('propertyPrice').value = params.get('price');
                updateSlider('propertyPrice');
            }
            if (params.has('down')) {
                document.getElementById('downPayment').value = params.get('down');
                updateSlider('downPayment');
            }
            
            // æ¯”è¼ƒãƒ¢ãƒ¼ãƒ‰
            if (params.has('compare') && params.get('compare') === '1') {
                document.getElementById('compareRates').checked = true;
                toggleComparisonMode();
                
                if (params.has('scenario')) {
                    document.getElementById('rateScenario').value = params.get('scenario');
                    updateScenarioDescription();
                }
                if (params.has('fixed')) {
                    document.getElementById('fixedRate').value = params.get('fixed');
                }
                if (params.has('variable')) {
                    document.getElementById('variableRate').value = params.get('variable');
                }
            }
            
            // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯è‡ªå‹•è¨ˆç®—
            if (params.has('p1age')) {
                setTimeout(() => {
                    calculate();
                }, 500);
            }
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
        window.onclick = function(event) {
            const modal = document.getElementById('shareModal');
            if (event.target === modal) {
                closeShareModal();
            }
        }
    </script>

    <!-- å›ºå®šã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œãƒœã‚¿ãƒ³ -->
    <div class="calculate-btn-fixed">
        <button class="calculate-btn" onclick="calculate()">
            ğŸ’¡ ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
        </button>
    </div>
</body>
</html>
